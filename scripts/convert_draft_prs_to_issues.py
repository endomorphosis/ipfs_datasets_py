#!/usr/bin/env python3
"""
Convert Draft PRs to Issues for Copilot

The correct way to invoke GitHub Copilot coding agents is to CREATE ISSUES,
not to comment on existing PRs. This script converts draft PRs into issues
that Copilot can then create PRs for.

Evidence:
- Issue #339 ‚Üí Copilot created PR #382 ‚úÖ WORKING
- @copilot comments on PRs ‚Üí No response ‚ùå NOT WORKING  
- 66 draft PRs have @copilot comments with no agent response
"""

import subprocess
import json
import sys
import argparse
from typing import Dict, List, Any
from datetime import datetime


class DraftPRToIssueConverter:
    """Convert draft PRs to issues for proper Copilot invocation."""
    
    def __init__(self, dry_run: bool = False):
        self.dry_run = dry_run
    
    def run_command(self, cmd: List[str], timeout: int = 30) -> Dict[str, Any]:
        """Run a command and return result."""
        try:
            result = subprocess.run(
                cmd,
                capture_output=True,
                text=True,
                timeout=timeout
            )
            return {
                'success': result.returncode == 0,
                'stdout': result.stdout,
                'stderr': result.stderr,
                'returncode': result.returncode
            }
        except Exception as e:
            return {'success': False, 'error': str(e)}
    
    def get_draft_prs(self, limit: int = 100) -> List[Dict[str, Any]]:
        """Get draft PRs that need conversion to issues."""
        print(f"üîç Fetching draft PRs...")
        
        result = self.run_command([
            'gh', 'pr', 'list',
            '--state', 'open',
            '--draft',
            '--limit', str(limit),
            '--json', 'number,title,body,author,url,headRefName'
        ])
        
        if not result['success']:
            print(f"‚ùå Failed to get PRs: {result.get('error')}")
            return []
        
        try:
            prs = json.loads(result['stdout'])
            return prs
        except json.JSONDecodeError:
            print(f"‚ùå Failed to parse PR data")
            return []
    
    def create_issue_from_pr(self, pr: Dict[str, Any]) -> bool:
        """
        Create an issue that describes the work needed in the PR.
        Copilot will then create a NEW PR to fix this issue.
        """
        pr_number = pr['number']
        pr_title = pr['title']
        pr_body = pr.get('body', '')
        pr_url = pr['url']
        branch = pr['headRefName']
        
        # Create issue title
        issue_title = f"Complete draft PR #{pr_number}: {pr_title}"
        
        # Create issue body
        issue_body = f"""# Work Needed: Complete Draft PR #{pr_number}

## Original PR Information

- **PR**: {pr_url}
- **Title**: {pr_title}
- **Branch**: `{branch}`

## Problem Description

This draft PR needs to be completed. The work involves:

{pr_body if pr_body else "No description provided in the original PR."}

## Task for Copilot

Please analyze the draft PR #{pr_number} and:

1. **Review** the current changes in the PR
2. **Identify** what work remains to be done
3. **Implement** the necessary changes
4. **Test** that the changes work correctly
5. **Create a PR** with your implementation

## Context

- This is an auto-generated issue from an incomplete draft PR
- The Copilot coding agent should create a new PR to complete this work
- Related PR: #{pr_number}

**Generated by:** Automated queue management system  
**Timestamp:** {datetime.now().isoformat()}
"""
        
        if self.dry_run:
            print(f"\n{'‚îÄ'*80}")
            print(f"DRY RUN: Would create issue:")
            print(f"Title: {issue_title}")
            print(f"Body preview: {issue_body[:200]}...")
            print(f"{'‚îÄ'*80}\n")
            return True
        
        # Create the issue (without labels to avoid rate limits)
        result = self.run_command([
            'gh', 'issue', 'create',
            '--title', issue_title,
            '--body', issue_body
        ])
        
        if result['success']:
            # Extract issue number from output
            output = result['stdout']
            if 'github.com' in output:
                issue_url = output.strip()
                print(f"‚úÖ Created issue: {issue_url}")
                return True
            else:
                print(f"‚úÖ Created issue for PR #{pr_number}")
                return True
        else:
            print(f"‚ùå Failed to create issue: {result.get('stderr')}")
            return False
    
    def convert_draft_prs_to_issues(self, max_conversions: int = 3) -> Dict[str, int]:
        """
        Convert draft PRs to issues.
        
        Args:
            max_conversions: Maximum number of PRs to convert
        
        Returns:
            Statistics dictionary
        """
        stats = {
            'total_draft_prs': 0,
            'converted': 0,
            'failed': 0,
            'skipped': 0
        }
        
        # Get draft PRs
        draft_prs = self.get_draft_prs()
        stats['total_draft_prs'] = len(draft_prs)
        
        print(f"\nüìä Found {len(draft_prs)} draft PRs")
        
        if len(draft_prs) == 0:
            print("‚úÖ No draft PRs found - queue is clear!")
            return stats
        
        converted_count = 0
        
        for pr in draft_prs:
            pr_number = pr['number']
            title = pr['title']
            author = pr['author']['login']
            
            print(f"\nüìã PR #{pr_number}: {title[:60]}...")
            print(f"   Author: {author}")
            
            # Skip PRs created by copilot-swe-agent (already done by Copilot)
            if author == 'app/copilot-swe-agent':
                print(f"   ‚è≠Ô∏è  Skipping - already created by Copilot")
                stats['skipped'] += 1
                continue
            
            # Check if we've reached max conversions
            if converted_count >= max_conversions:
                print(f"   ‚è∏Ô∏è  Reached max conversions ({max_conversions})")
                break
            
            # Convert PR to issue
            success = self.create_issue_from_pr(pr)
            
            if success:
                stats['converted'] += 1
                converted_count += 1
                print(f"   ‚úÖ Converted PR #{pr_number} to issue")
            else:
                stats['failed'] += 1
                print(f"   ‚ùå Failed to convert PR #{pr_number}")
        
        return stats
    
    def print_summary(self, stats: Dict[str, int]):
        """Print summary statistics."""
        print(f"\n{'='*80}")
        print(f"üìä Draft PR to Issue Conversion Summary")
        print(f"{'='*80}")
        print(f"Total draft PRs:        {stats['total_draft_prs']}")
        print(f"Converted to issues:    {stats['converted']}")
        print(f"Failed:                 {stats['failed']}")
        print(f"Skipped:                {stats['skipped']}")
        print(f"{'='*80}")
        
        if stats['converted'] > 0:
            print(f"\n‚úÖ Successfully created {stats['converted']} issue(s)")
            print(f"üí° Copilot will now create new PRs to fix these issues")
            print(f"üîó Check: https://github.com/endomorphosis/ipfs_datasets_py/issues")
        else:
            print(f"\n‚ö†Ô∏è  No conversions made")


def main():
    """Main execution."""
    parser = argparse.ArgumentParser(
        description='Convert draft PRs to issues for proper Copilot invocation'
    )
    parser.add_argument(
        '--max-conversions',
        type=int,
        default=3,
        help='Maximum number of PRs to convert (default: 3)'
    )
    parser.add_argument(
        '--dry-run',
        action='store_true',
        help='Dry run mode - show what would be done'
    )
    
    args = parser.parse_args()
    
    converter = DraftPRToIssueConverter(dry_run=args.dry_run)
    
    if args.dry_run:
        print("üîç DRY RUN MODE - No actual changes will be made\n")
    
    print("üí° PROPER COPILOT INVOCATION METHOD:")
    print("   1. Create an issue describing the work")
    print("   2. Copilot automatically creates a PR to fix it")
    print("   3. NOT: Commenting @copilot on existing PRs\n")
    
    try:
        stats = converter.convert_draft_prs_to_issues(max_conversions=args.max_conversions)
        converter.print_summary(stats)
        
        sys.exit(0 if stats['failed'] == 0 else 1)
        
    except KeyboardInterrupt:
        print("\n\n‚ö†Ô∏è  Interrupted by user")
        sys.exit(1)
    except Exception as e:
        print(f"\nüí• Error: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)


if __name__ == '__main__':
    main()