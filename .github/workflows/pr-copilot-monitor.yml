name: Draft PR Copilot Monitor
true:
  schedule:
  - cron: '*/10 * * * *'
  workflow_dispatch:
    inputs:
      max_drafts:
        description: 'Maximum draft PRs to create (default: 3)'
        required: false
        type: number
        default: 3
      dry_run:
        description: Dry run mode (no actual changes)
        required: false
        type: boolean
        default: false
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
jobs:
  draft-pr-copilot-monitor:
    name: Monitor PRs and Create Draft PRs for Copilot
    runs-on:
    - self-hosted
    - linux
    - x64
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
    - name: Clean workspace
      run: "# Fix permissions and clean workspace before checkout\nif [ -d \"$GITHUB_WORKSPACE\" ]; then\n  sudo chown -R\
        \ $(whoami):$(whoami) \"$GITHUB_WORKSPACE\" 2>/dev/null || true\n  sudo chmod -R u+rwX \"$GITHUB_WORKSPACE\" 2>/dev/null\
        \ || true\n  rm -rf \"$GITHUB_WORKSPACE\"/* \"$GITHUB_WORKSPACE\"/.* 2>/dev/null || true\nfi\n"
      continue-on-error: true
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 1
        clean: true
    - name: Verify Python installation
      run: "python3 --version || python --version\necho \"\u2705 Python is available\"\n"
    - name: Setup GitHub CLI and P2P Cache
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        ENABLE_P2P_CACHE: true
      run: '# Use the centralized setup script

        source scripts/ci/setup_gh_auth_and_p2p.sh

        '
    - name: Run Draft PR Copilot Invoker
      id: monitor
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: "MAX_DRAFTS=\"${{ github.event.inputs.max_drafts || 3 }}\"\nDRY_RUN=\"${{ github.event.inputs.dry_run || 'false'\
        \ }}\"\n\necho \"\U0001F50D Draft PR Copilot Invoker Configuration:\"\necho \"  Max Draft PRs: $MAX_DRAFTS\"\necho\
        \ \"  Dry Run: $DRY_RUN\"\necho \"\"\n\n# Build command using the NEW draft PR invoker\nCMD=\"python3 scripts/draft_pr_copilot_invoker.py\
        \ --max-drafts $MAX_DRAFTS\"\n\nif [ \"$DRY_RUN\" = \"true\" ]; then\n  CMD=\"$CMD --dry-run\"\nfi\n\necho \"Running:\
        \ $CMD\"\necho \"\"\n\n# Run the monitor\nif eval \"$CMD\" 2>&1 | tee monitor_output.log; then\n  echo \"\u2705 Monitor\
        \ completed successfully\"\n  MONITOR_SUCCESS=true\nelse\n  echo \"\u274C Monitor failed\"\n  MONITOR_SUCCESS=false\n\
        fi\n\n# Extract metrics\nTOTAL_PRS=$(grep \"Total draft PRs:\" monitor_output.log | sed -n 's/.*Total draft PRs:[[:space:]]*\\\
        ([0-9]*\\).*/\\1/p' | tail -1 || echo \"0\")\nNEEDS_WORK=$(grep \"PRs needing work:\" monitor_output.log | sed -n\
        \ 's/.*PRs needing work:[[:space:]]*\\([0-9]*\\).*/\\1/p' | tail -1 || echo \"0\")\nDRAFTS_CREATED=$(grep \"Draft\
        \ PRs created:\" monitor_output.log | sed -n 's/.*Draft PRs created:[[:space:]]*\\([0-9]*\\).*/\\1/p' | tail -1 ||\
        \ echo \"0\")\nERRORS=$(grep \"Errors:\" monitor_output.log | sed -n 's/.*Errors:[[:space:]]*\\([0-9]*\\).*/\\1/p'\
        \ | tail -1 || echo \"0\")\n\n# Set outputs\necho \"total_prs=$TOTAL_PRS\" >> $GITHUB_OUTPUT\necho \"needs_work=$NEEDS_WORK\"\
        \ >> $GITHUB_OUTPUT\necho \"drafts_created=$DRAFTS_CREATED\" >> $GITHUB_OUTPUT\necho \"errors=$ERRORS\" >> $GITHUB_OUTPUT\n\
        echo \"success=$MONITOR_SUCCESS\" >> $GITHUB_OUTPUT\n\necho \"\"\necho \"\U0001F4CA Summary: $TOTAL_PRS total, $NEEDS_WORK\
        \ need work, $DRAFTS_CREATED draft PRs created\"\n\nif [ \"$MONITOR_SUCCESS\" != \"true\" ]; then\n  exit 1\nfi\n"
    - name: Generate Summary
      if: always()
      run: "echo \"## \U0001F916 PR Copilot Monitor Results\" >> $GITHUB_STEP_SUMMARY\necho \"\" >> $GITHUB_STEP_SUMMARY\n\
        echo \"**Run**: ${{ github.run_number }}\" >> $GITHUB_STEP_SUMMARY\necho \"**Date**: $(date -u +\"%Y-%m-%d %H:%M:%S\
        \ UTC\")\" >> $GITHUB_STEP_SUMMARY\necho \"\" >> $GITHUB_STEP_SUMMARY\n\necho \"### \U0001F4CA Statistics\" >> $GITHUB_STEP_SUMMARY\n\
        echo \"- **Total draft PRs**: ${{ steps.monitor.outputs.total_prs }}\" >> $GITHUB_STEP_SUMMARY\necho \"- **PRs needing\
        \ work**: ${{ steps.monitor.outputs.needs_work }}\" >> $GITHUB_STEP_SUMMARY\necho \"- **Draft PRs created**: ${{ steps.monitor.outputs.drafts_created\
        \ }}\" >> $GITHUB_STEP_SUMMARY\necho \"- **Errors**: ${{ steps.monitor.outputs.errors }}\" >> $GITHUB_STEP_SUMMARY\n\
        echo \"\" >> $GITHUB_STEP_SUMMARY\n\necho \"### \U0001F4A1 How It Works\" >> $GITHUB_STEP_SUMMARY\necho \"1. **Monitor\
        \ Draft PRs**: Analyzes all open draft PRs\" >> $GITHUB_STEP_SUMMARY\necho \"2. **Create Draft PRs**: Creates draft\
        \ PRs for Copilot to work on (VS Code method)\" >> $GITHUB_STEP_SUMMARY\necho \"3. **Copilot Responds**: Copilot **automatically**\
        \ detects and implements changes\" >> $GITHUB_STEP_SUMMARY\necho \"4. **Proven Method**: Uses draft PR invocation\
        \ from VS Code (PR #401)\" >> $GITHUB_STEP_SUMMARY\necho \"5. **Fallback**: gh agent-task create (when enabled)\"\
        \ >> $GITHUB_STEP_SUMMARY\necho \"6. **Proper Method**: Documents the correct Copilot invocation path\" >> $GITHUB_STEP_SUMMARY\n\
        echo \"\" >> $GITHUB_STEP_SUMMARY\n\nif [ \"${{ steps.monitor.outputs.drafts_created }}\" -gt 0 ]; then\n  echo \"\
        \u2705 **Created ${{ steps.monitor.outputs.drafts_created }} draft PR(s)**\" >> $GITHUB_STEP_SUMMARY\n  echo \"Copilot\
        \ will automatically detect and work on these PRs.\" >> $GITHUB_STEP_SUMMARY\nelif [ \"${{ steps.monitor.outputs.needs_work\
        \ }}\" -eq 0 ]; then\n  echo \"\u2705 **All draft PRs are up to date**\" >> $GITHUB_STEP_SUMMARY\nelse\n  echo \"\u23F3\
        \ **Waiting for Copilot**\" >> $GITHUB_STEP_SUMMARY\n  echo \"Issues already exist for incomplete PRs.\" >> $GITHUB_STEP_SUMMARY\n\
        fi\n\necho \"\" >> $GITHUB_STEP_SUMMARY\necho \"---\" >> $GITHUB_STEP_SUMMARY\necho \"*Next run: $(date -d '+10 minutes'\
        \ -u +\"%Y-%m-%d %H:%M:%S UTC\")*\" >> $GITHUB_STEP_SUMMARY\n"
    - name: Archive Monitor Output
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: pr-copilot-monitor-output-${{ github.run_number }}
        path: monitor_output.log
        retention-days: 7
