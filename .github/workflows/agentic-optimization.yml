name: Agentic Code Optimization
permissions:
  contents: read
true:
  schedule:
  - cron: 0 0 * * 1
  workflow_dispatch:
    inputs:
      target_files:
        description: Target files or directories (comma-separated)
        required: false
        default: ipfs_datasets_py/
      optimization_method:
        description: Optimization method to use
        required: false
        default: test_driven
        type: choice
        options:
        - test_driven
        - adversarial
        - actor_critic
        - chaos
      priority:
        description: Task priority (0-100)
        required: false
        default: '50'
      validation_level:
        description: Validation level
        required: false
        default: standard
        type: choice
        options:
        - basic
        - standard
        - strict
        - paranoid
      dry_run:
        description: Dry run (no changes made)
        required: false
        default: false
        type: boolean
  issues:
    types:
    - labeled
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
jobs:
  check-trigger:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      target_files: ${{ steps.check.outputs.target_files }}
      method: ${{ steps.check.outputs.method }}
    steps:
    - name: Check if optimization requested
      id: check
      env:
        EVENT_NAME: ${{ github.event_name }}
        HAS_OPTIMIZE_LABEL: ${{ contains(github.event.issue.labels.*.name, 'optimize') }}
        INPUT_TARGET_FILES: ${{ github.event.inputs.target_files || 'ipfs_datasets_py/' }}
        INPUT_METHOD: ${{ github.event.inputs.optimization_method || 'test_driven' }}
      run: "if [[ \"${EVENT_NAME}\" == \"issues\" ]]; then\n  if [[ \"${HAS_OPTIMIZE_LABEL}\" == \"true\" ]]; then\n    echo\
        \ \"should_run=true\" >> $GITHUB_OUTPUT\n    # Parse issue body for targets\n    echo \"target_files=ipfs_datasets_py/\"\
        \ >> $GITHUB_OUTPUT\n    echo \"method=test_driven\" >> $GITHUB_OUTPUT\n  else\n    echo \"should_run=false\" >> $GITHUB_OUTPUT\n\
        \  fi\nelse\n  echo \"should_run=true\" >> $GITHUB_OUTPUT\n  echo \"target_files=${INPUT_TARGET_FILES}\" >> $GITHUB_OUTPUT\n\
        \  echo \"method=${INPUT_METHOD}\" >> $GITHUB_OUTPUT\nfi\n"
  optimize:
    needs: check-trigger
    if: needs.check-trigger.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 0
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: pip
    - name: Install dependencies
      run: 'python -m pip install --upgrade pip

        pip install -e ".[test]"

        # Install optional dependencies for optimization

        pip install mypy pytest flake8 || true

        '
    - name: Check GitHub API rate limits
      id: rate_limit
      run: "REMAINING=$(curl -H \"Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}\" \\\n  https://api.github.com/rate_limit\
        \ | jq -r '.rate.remaining')\necho \"remaining=$REMAINING\" >> $GITHUB_OUTPUT\n\nif [ \"$REMAINING\" -lt 100 ]; then\n\
        \  echo \"::warning::GitHub API rate limit low: $REMAINING requests remaining\"\n  echo \"use_patch_mode=true\" >>\
        \ $GITHUB_OUTPUT\nelse\n  echo \"use_patch_mode=false\" >> $GITHUB_OUTPUT\nfi\n"
    - name: Configure optimizer
      env:
        CHANGE_CONTROL: ${{ steps.rate_limit.outputs.use_patch_mode == 'true' && 'patch' || 'github' }}
        VALIDATION_LEVEL: ${{ github.event.inputs.validation_level || 'standard' }}
      run: "python -m ipfs_datasets_py.optimizers.agentic.cli config set \\\n  --key change_control \\\n  --value \"${CHANGE_CONTROL}\"\
        \n\npython -m ipfs_datasets_py.optimizers.agentic.cli config set \\\n  --key validation_level \\\n  --value \"${VALIDATION_LEVEL}\"\
        \n"
    - name: Run optimization
      id: optimize
      env:
        IPFS_DATASETS_PY_LLM_PROVIDER: ${{ vars.LLM_PROVIDER || 'local' }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        TARGET: ${{ needs.check-trigger.outputs.target_files }}
        METHOD: ${{ needs.check-trigger.outputs.method }}
        PRIORITY: ${{ github.event.inputs.priority || '50' }}
        DRY_RUN: ${{ github.event.inputs.dry_run == true && '--dry-run' || '' }}
      run: "echo \"Running optimization...\"\necho \"Target: ${TARGET}\"\necho \"Method: ${METHOD}\"\necho \"Priority: ${PRIORITY}\"\
        \n\npython -m ipfs_datasets_py.optimizers.agentic.cli optimize \\\n  --method \"${METHOD}\" \\\n  --target \"${TARGET}\"\
        \ \\\n  --description \"Automated code optimization via GitHub Actions\" \\\n  --priority \"${PRIORITY}\" \\\n  ${DRY_RUN}\
        \ \\\n  2>&1 | tee optimization.log\n\n# Check if optimization succeeded\nif [ $? -eq 0 ]; then\n  echo \"success=true\"\
        \ >> $GITHUB_OUTPUT\nelse\n  echo \"success=false\" >> $GITHUB_OUTPUT\nfi\n"
    - name: Validate changes
      if: steps.optimize.outputs.success == 'true' && github.event.inputs.dry_run != true
      env:
        VALIDATION_LEVEL: ${{ github.event.inputs.validation_level || 'standard' }}
      run: "# Run validation on changed files\ngit diff --name-only > changed_files.txt\n\nwhile IFS= read -r file; do\n \
        \ if [[ \"$file\" == *.py ]]; then\n    echo \"Validating $file...\"\n    python -m ipfs_datasets_py.optimizers.agentic.cli\
        \ validate \\\n      \"$file\" \\\n      --level \"${VALIDATION_LEVEL}\" \\\n      || echo \"::warning::Validation\
        \ failed for $file\"\n  fi\ndone < changed_files.txt\n"
    - name: Create Pull Request
      if: steps.optimize.outputs.success == 'true' && github.event.inputs.dry_run != true
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "\U0001F916 Automated code optimization\n\nMethod: ${{ needs.check-trigger.outputs.method }}\nTarget:\
          \ ${{ needs.check-trigger.outputs.target_files }}\nValidation: ${{ github.event.inputs.validation_level || 'standard'\
          \ }}\n\nGenerated by GitHub Actions workflow\n"
        branch: automated-optimization-${{ github.run_number }}
        title: "\U0001F916 Automated Code Optimization (${{ needs.check-trigger.outputs.method }})"
        body: "## Automated Code Optimization\n\n**Method:** `${{ needs.check-trigger.outputs.method }}`  \n**Target:** `${{\
          \ needs.check-trigger.outputs.target_files }}`  \n**Validation Level:** `${{ github.event.inputs.validation_level\
          \ || 'standard' }}`  \n**Priority:** `${{ github.event.inputs.priority || '50' }}`\n\n### Changes\n\nThis PR contains\
          \ automated code optimizations generated by the agentic optimizer.\n\n### Validation\n\nAll changes have been validated\
          \ at the `${{ github.event.inputs.validation_level || 'standard' }}` level.\n\n### Review Checklist\n\n- [ ] Review\
          \ code changes for correctness\n- [ ] Verify tests pass\n- [ ] Check performance improvements\n- [ ] Ensure backward\
          \ compatibility\n- [ ] Approve and merge if satisfactory\n\n---\n\nGenerated by [Agentic Optimizer](.github/workflows/agentic-optimization.yml)\
          \  \nWorkflow Run: #${{ github.run_number }}\n"
        labels: 'automated

          optimization

          ${{ needs.check-trigger.outputs.method }}

          '
        draft: true
    - name: Get optimization statistics
      if: always()
      run: 'echo "## Optimization Statistics" >> $GITHUB_STEP_SUMMARY

        python -m ipfs_datasets_py.optimizers.agentic.cli stats >> $GITHUB_STEP_SUMMARY 2>&1 || true

        '
    - name: Upload optimization log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: optimization-log
        path: optimization.log
        retention-days: 30
    - name: Comment on issue
      if: github.event_name == 'issues' && steps.optimize.outputs.success == 'true'
      uses: actions/github-script@v7
      with:
        script: "github.rest.issues.createComment({\n  issue_number: context.issue.number,\n  owner: context.repo.owner,\n\
          \  repo: context.repo.repo,\n  body: `\u2705 Optimization completed successfully!\n  \n  A draft PR has been created\
          \ with the optimized code.\n  Review the changes and merge if satisfactory.\n  \n  Workflow: ${{ github.server_url\
          \ }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`\n})\n"
    - name: Report failure
      if: failure() && github.event_name == 'issues'
      uses: actions/github-script@v7
      with:
        script: "github.rest.issues.createComment({\n  issue_number: context.issue.number,\n  owner: context.repo.owner,\n\
          \  repo: context.repo.repo,\n  body: `\u274C Optimization failed.\n  \n  Check the workflow logs for details:\n\
          \  ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`\n})\n"
