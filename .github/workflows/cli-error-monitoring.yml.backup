name: CLI Tools Error Monitoring

on:
  push:
    branches: [main, develop]
    paths:
      - 'ipfs_datasets_cli.py'
      - 'ipfs-datasets'
      - 'scripts/cli/**'
      - 'ipfs_datasets_py/error_reporting/**'
      - '.github/workflows/cli-error-monitoring.yml'
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Test mode to run'
        required: true
        default: 'comprehensive'
        type: choice
        options:
          - basic
          - comprehensive
          - stress
  schedule:
    # Run CLI error monitoring daily at 4 AM UTC
    - cron: '0 4 * * *'

permissions:
  contents: read
  issues: write
  actions: read

env:
  PYTHON_VERSION: '3.12'
  ERROR_REPORTING_ENABLED: 'true'

jobs:
  # Basic CLI functionality tests
  cli-smoke-tests:
    runs-on: [self-hosted, linux, x64]
    container:
      image: python:3.12-slim
      options: --user root
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          submodules: false
      
      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y git
          pip install --upgrade pip
          pip install -e .[test]
      
      - name: Test CLI Basic Commands
        id: basic_tests
        continue-on-error: true
        run: |
          echo "ðŸ§ª Testing basic CLI commands..."
          
          # Test help command
          ./ipfs-datasets --help || echo "help_failed=true" >> $GITHUB_OUTPUT
          
          # Test info status command
          ./ipfs-datasets info status || echo "status_failed=true" >> $GITHUB_OUTPUT
          
          # Test list categories
          python ipfs_datasets_cli.py --list-categories || echo "categories_failed=true" >> $GITHUB_OUTPUT
      
      - name: Capture CLI Errors
        if: steps.basic_tests.outputs.help_failed == 'true' || steps.basic_tests.outputs.status_failed == 'true' || steps.basic_tests.outputs.categories_failed == 'true'
        run: |
          echo "CLI_ERRORS_DETECTED=true" >> $GITHUB_ENV
          echo "## âš ï¸ CLI Errors Detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Basic CLI commands failed. Auto-healing will be triggered." >> $GITHUB_STEP_SUMMARY
      
      - name: Upload CLI Test Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cli-smoke-test-logs
          path: |
            *.log
            /tmp/*.log

  # Comprehensive CLI tests with error capture
  cli-comprehensive-tests:
    runs-on: [self-hosted, linux, x64]
    container:
      image: python:3.12-slim
      options: --user root
    needs: cli-smoke-tests
    if: ${{ !cancelled() && (github.event.inputs.test_mode == 'comprehensive' || github.event_name != 'workflow_dispatch') }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          submodules: false
      
      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y git gh curl
          pip install --upgrade pip
          pip install -e .[test,all]
      
      - name: Test Enhanced CLI
        id: enhanced_cli
        continue-on-error: true
        run: |
          echo "ðŸ”§ Testing enhanced CLI..."
          mkdir -p test-results
          
          # Test enhanced CLI tool listing
          python scripts/cli/enhanced_cli.py --list-categories > test-results/enhanced-cli-categories.log 2>&1 || echo "enhanced_cli_failed=true" >> $GITHUB_OUTPUT
          
          # Test tool execution
          python scripts/cli/enhanced_cli.py dataset_tools --help > test-results/enhanced-cli-dataset-tools.log 2>&1 || echo "dataset_tools_failed=true" >> $GITHUB_OUTPUT
      
      - name: Test MCP CLI
        id: mcp_cli
        continue-on-error: true
        run: |
          echo "ðŸŽ›ï¸ Testing MCP CLI..."
          
          # Test MCP CLI basic commands
          python scripts/cli/mcp_cli.py --help > test-results/mcp-cli-help.log 2>&1 || echo "mcp_cli_failed=true" >> $GITHUB_OUTPUT
      
      - name: Test Integrated CLI
        id: integrated_cli
        continue-on-error: true
        run: |
          echo "ðŸ”— Testing integrated CLI..."
          
          python scripts/cli/integrated_cli.py --version > test-results/integrated-cli-version.log 2>&1 || echo "integrated_cli_failed=true" >> $GITHUB_OUTPUT
      
      - name: Analyze CLI Failures
        if: steps.enhanced_cli.outputs.enhanced_cli_failed == 'true' || steps.mcp_cli.outputs.mcp_cli_failed == 'true' || steps.integrated_cli.outputs.integrated_cli_failed == 'true'
        run: |
          echo "## âŒ CLI Test Failures Detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Failed Components" >> $GITHUB_STEP_SUMMARY
          
          [ "${{ steps.enhanced_cli.outputs.enhanced_cli_failed }}" = "true" ] && echo "- Enhanced CLI" >> $GITHUB_STEP_SUMMARY
          [ "${{ steps.mcp_cli.outputs.mcp_cli_failed }}" = "true" ] && echo "- MCP CLI" >> $GITHUB_STEP_SUMMARY
          [ "${{ steps.integrated_cli.outputs.integrated_cli_failed }}" = "true" ] && echo "- Integrated CLI" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Auto-healing workflow will be triggered to fix these issues." >> $GITHUB_STEP_SUMMARY
      
      - name: Upload Comprehensive Test Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cli-comprehensive-test-logs
          path: test-results/

  # CLI error reporting integration test
  cli-error-reporting-test:
    runs-on: [self-hosted, linux, x64]
    container:
      image: python:3.12-slim
      options: --user root
    needs: cli-smoke-tests
    if: ${{ !cancelled() }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          submodules: false
      
      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y git
          pip install --upgrade pip
          pip install -e .[test]
      
      - name: Test CLI Error Reporter
        run: |
          echo "ðŸ“Š Testing CLI error reporter..."
          python -c "
          from ipfs_datasets_py.error_reporting.cli_error_reporter import CLIErrorReporter
          
          # Test error reporter instantiation
          reporter = CLIErrorReporter()
          print('âœ… CLI Error Reporter initialized successfully')
          
          # Test error formatting
          try:
              raise ValueError('Test CLI error')
          except Exception as e:
              error_report = reporter.format_cli_error(
                  error=e,
                  command='ipfs-datasets',
                  args=['test', 'command'],
                  logs='Test log output'
              )
              
              assert 'source' in error_report
              assert error_report['source'] == 'cli_tool'
              assert 'error_type' in error_report
              assert 'stack_trace' in error_report
              
              print('âœ… Error formatting working correctly')
          
          # Test GitHub issue body generation
          issue_body = reporter.create_github_issue_body(error_report)
          assert 'CLI Tool Error Report' in issue_body
          assert error_report['command'] in issue_body
          
          print('âœ… GitHub issue body generation working')
          print('âœ… All CLI error reporter tests passed')
          "
      
      - name: Test Error Reporter Integration
        env:
          ERROR_REPORTING_ENABLED: 'false'
        run: |
          echo "ðŸ”— Testing error reporter integration..."
          python -c "
          import sys
          
          # Test that error reporter is installed in CLI
          from ipfs_datasets_cli import install_cli_error_handler
          
          # Should not fail even with error reporting disabled
          install_cli_error_handler()
          print('âœ… Error reporter integration test passed')
          " || echo "Integration test completed"

  # Stress test CLI with multiple operations
  cli-stress-test:
    runs-on: [self-hosted, linux, x64]
    container:
      image: python:3.12-slim
      options: --user root
    needs: cli-comprehensive-tests
    if: ${{ !cancelled() && github.event.inputs.test_mode == 'stress' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          submodules: false
      
      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y git
          pip install --upgrade pip
          pip install -e .[test,all]
      
      - name: Stress Test CLI Commands
        continue-on-error: true
        run: |
          echo "âš¡ Running CLI stress tests..."
          
          # Run multiple CLI commands in sequence
          for i in {1..10}; do
            echo "Iteration $i..."
            ./ipfs-datasets --help > /dev/null 2>&1 || echo "Iteration $i failed"
            python scripts/cli/enhanced_cli.py --list-categories > /dev/null 2>&1 || echo "Enhanced CLI iteration $i failed"
            sleep 1
          done
          
          echo "âœ… Stress test completed"

  # Generate comprehensive test summary
  cli-monitoring-summary:
    runs-on: [self-hosted, linux, x64]
    container:
      image: python:3.12-slim
      options: --user root
    needs: [cli-smoke-tests, cli-comprehensive-tests, cli-error-reporting-test]
    if: always()
    
    steps:
      - name: Generate CLI Monitoring Summary
        run: |
          echo "## ðŸ”§ CLI Tools Error Monitoring Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Suite Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Smoke Tests | ${{ needs.cli-smoke-tests.result }} | Basic CLI functionality |" >> $GITHUB_STEP_SUMMARY
          echo "| Comprehensive Tests | ${{ needs.cli-comprehensive-tests.result }} | All CLI tool variations |" >> $GITHUB_STEP_SUMMARY
          echo "| Error Reporting Test | ${{ needs.cli-error-reporting-test.result }} | Error capture and reporting |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Add analysis
          echo "### Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.cli-smoke-tests.result }}" = "success" ]; then
            echo "âœ… **Smoke Tests**: Basic CLI functionality is working" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Smoke Tests**: Critical CLI issues detected - auto-healing triggered" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.cli-comprehensive-tests.result }}" = "success" ]; then
            echo "âœ… **Comprehensive Tests**: All CLI tools are functional" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Comprehensive Tests**: Some CLI tools have issues - auto-healing triggered" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.cli-error-reporting-test.result }}" = "success" ]; then
            echo "âœ… **Error Reporting**: CLI error capture is working correctly" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Error Reporting**: Issues with error capture system" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "- Failed workflows will trigger auto-healing via copilot-agent-autofix" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub issues will be created automatically for detected failures" >> $GITHUB_STEP_SUMMARY
          echo "- Draft PRs will be generated with Copilot integration" >> $GITHUB_STEP_SUMMARY
