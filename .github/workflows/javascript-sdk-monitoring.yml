name: JavaScript SDK Error Monitoring
true:
  push:
    branches:
    - main
    - develop
    paths:
    - ipfs_datasets_py/static/js/mcp-sdk.js
    - ipfs_datasets_py/static/js/mcp-api-client.js
    - ipfs_datasets_py/static/js/mcp_client_sdk.js
    - ipfs_datasets_py/static/js/error-reporter.js
    - .github/workflows/javascript-sdk-monitoring.yml
  pull_request:
    branches:
    - main
    - develop
  workflow_dispatch:
    inputs:
      test_mode:
        description: Test mode to run
        required: true
        default: comprehensive
        type: choice
        options:
        - basic
        - comprehensive
        - browser
  schedule:
  - cron: 0 5 * * *
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
permissions:
  contents: read
  issues: write
  actions: read
env:
  PYTHON_VERSION: '3.12'
  NODE_VERSION: '20'
jobs:
  sdk-static-analysis:
    runs-on:
    - self-hosted
    - linux
    - x64
    timeout-minutes: 45
    container:
      image: node:20-slim
      options: --user root
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 1
        submodules: false
    - name: Install linting tools
      run: 'npm install -g eslint jshint

        '
    - name: Lint MCP SDK
      id: lint_sdk
      continue-on-error: true
      run: "echo \"\U0001F50D Linting MCP SDK...\"\n\n# Create a basic .eslintrc.json if it doesn't exist\nif [ ! -f .eslintrc.json\
        \ ]; then\n  cat > .eslintrc.json << 'EOF'\n{\n  \"env\": {\n    \"browser\": true,\n    \"es2021\": true\n  },\n\
        \  \"extends\": \"eslint:recommended\",\n  \"parserOptions\": {\n    \"ecmaVersion\": 12\n  },\n  \"rules\": {\n \
        \   \"no-unused-vars\": \"warn\",\n    \"no-undef\": \"error\"\n  }\n}\nEOF\nfi\n\n# Lint SDK files\neslint ipfs_datasets_py/static/js/mcp-sdk.js\
        \ || echo \"sdk_lint_failed=true\" >> $GITHUB_OUTPUT\neslint ipfs_datasets_py/static/js/mcp-api-client.js || echo\
        \ \"api_client_lint_failed=true\" >> $GITHUB_OUTPUT\neslint ipfs_datasets_py/static/js/error-reporter.js || echo \"\
        error_reporter_lint_failed=true\" >> $GITHUB_OUTPUT\n"
    - name: Check for Syntax Errors
      id: syntax_check
      continue-on-error: true
      run: "echo \"\u2705 Checking JavaScript syntax...\"\nnode --check ipfs_datasets_py/static/js/mcp-sdk.js || echo \"sdk_syntax_error=true\"\
        \ >> $GITHUB_OUTPUT\nnode --check ipfs_datasets_py/static/js/mcp-api-client.js || echo \"api_syntax_error=true\" >>\
        \ $GITHUB_OUTPUT\nnode --check ipfs_datasets_py/static/js/error-reporter.js || echo \"error_reporter_syntax_error=true\"\
        \ >> $GITHUB_OUTPUT\n"
    - name: Report Syntax Issues
      if: steps.syntax_check.outputs.sdk_syntax_error == 'true' || steps.syntax_check.outputs.api_syntax_error == 'true' ||
        steps.syntax_check.outputs.error_reporter_syntax_error == 'true'
      run: "echo \"## \u274C JavaScript Syntax Errors Detected\" >> $GITHUB_STEP_SUMMARY\necho \"\" >> $GITHUB_STEP_SUMMARY\n\
        echo \"Critical syntax errors found in SDK files. Auto-healing will be triggered.\" >> $GITHUB_STEP_SUMMARY\n"
  sdk-functionality-tests:
    runs-on:
    - self-hosted
    - linux
    - x64
    timeout-minutes: 45
    container:
      image: python:3.12-slim
      options: --user root
    needs: sdk-static-analysis
    if: ${{ !cancelled() }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 1
        submodules: false
    - name: Install dependencies
      run: 'apt-get update

        apt-get install -y git curl nodejs npm

        pip install --upgrade pip

        pip install -e .[test]

        '
    - name: Start MCP Dashboard for SDK Testing
      run: "echo \"\U0001F680 Starting MCP Dashboard...\"\npython -m ipfs_datasets_py.mcp_dashboard &\nMCP_PID=$!\necho \"\
        MCP_DASHBOARD_PID=$MCP_PID\" >> $GITHUB_ENV\n\n# Wait for dashboard to be ready\nfor i in {1..60}; do\n  if curl -f\
        \ http://127.0.0.1:8899/api/health 2>/dev/null; then\n    echo \"\u2705 Dashboard is ready!\"\n    break\n  fi\n \
        \ if [ $i -eq 60 ]; then\n    echo \"\u274C Dashboard failed to start\"\n    exit 1\n  fi\n  sleep 2\ndone\n"
    - name: Test SDK API Calls
      id: sdk_api_tests
      continue-on-error: true
      run: "echo \"\U0001F9EA Testing SDK API functionality...\"\n\n# Create a Node.js test script\ncat > test_sdk.js << 'EOF'\n\
        const http = require('http');\n\n// Test health endpoint\nfunction testHealthEndpoint() {\n  return new Promise((resolve,\
        \ reject) => {\n    const req = http.get('http://127.0.0.1:8899/api/health', (res) => {\n      let data = '';\n  \
        \    res.on('data', chunk => data += chunk);\n      res.on('end', () => {\n        if (res.statusCode === 200) {\n\
        \          console.log('\u2705 Health endpoint working');\n          resolve(true);\n        } else {\n          console.log('\u274C\
        \ Health endpoint failed:', res.statusCode);\n          reject(false);\n        }\n      });\n    });\n    req.on('error',\
        \ reject);\n    req.setTimeout(5000, () => {\n      req.destroy();\n      reject(new Error('Timeout'));\n    });\n\
        \  });\n}\n\n// Test MCP tools endpoint\nfunction testToolsEndpoint() {\n  return new Promise((resolve, reject) =>\
        \ {\n    const req = http.get('http://127.0.0.1:8899/api/mcp/tools', (res) => {\n      let data = '';\n      res.on('data',\
        \ chunk => data += chunk);\n      res.on('end', () => {\n        if (res.statusCode === 200) {\n          try {\n\
        \            const tools = JSON.parse(data);\n            console.log(`\u2705 Tools endpoint working (${Array.isArray(tools)\
        \ ? tools.length : Object.keys(tools).length} tools)`);\n            resolve(true);\n          } catch (e) {\n   \
        \         console.log('\u274C Tools endpoint returned invalid JSON');\n            reject(false);\n          }\n \
        \       } else {\n          console.log('\u274C Tools endpoint failed:', res.statusCode);\n          reject(false);\n\
        \        }\n      });\n    });\n    req.on('error', reject);\n    req.setTimeout(10000, () => {\n      req.destroy();\n\
        \      reject(new Error('Timeout'));\n    });\n  });\n}\n\n// Run tests\n(async () => {\n  try {\n    await testHealthEndpoint();\n\
        \    await testToolsEndpoint();\n    console.log('\u2705 All SDK API tests passed');\n    process.exit(0);\n  } catch\
        \ (error) {\n    console.error('\u274C SDK API tests failed:', error);\n    process.exit(1);\n  }\n})();\nEOF\n\n\
        node test_sdk.js || echo \"sdk_api_failed=true\" >> $GITHUB_OUTPUT\n"
    - name: Stop Dashboard
      if: always()
      run: "if [ ! -z \"$MCP_DASHBOARD_PID\" ]; then\n  kill $MCP_DASHBOARD_PID || true\nfi\npkill -f \"mcp_dashboard\" ||\
        \ true\n"
  js-error-reporter-test:
    runs-on:
    - self-hosted
    - linux
    - x64
    timeout-minutes: 45
    container:
      image: node:20-slim
      options: --user root
    needs: sdk-static-analysis
    if: ${{ !cancelled() }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 1
        submodules: false
    - name: Test Error Reporter Class
      run: "echo \"\U0001F9EA Testing JavaScript Error Reporter...\"\n\n# Create a test script for error reporter\ncat > test_error_reporter.js\
        \ << 'EOF'\n// Load the error reporter code (simplified for Node.js environment)\nclass JavaScriptErrorReporter {\n\
        \  constructor(options = {}) {\n    this.enabled = options.enabled !== undefined ? options.enabled : false;\n    this.endpoint\
        \ = options.endpoint || '/api/report-error';\n    this.reportedErrors = new Set();\n    this.minReportInterval = options.minReportInterval\
        \ || 3600000;\n    this.maxReportsPerSession = options.maxReportsPerSession || 10;\n    this.reportCount = 0;\n  }\n\
        \  \n  computeErrorHash(errorType, errorMessage, errorLocation) {\n    const content = `${errorType}|${errorMessage}|${errorLocation}`;\n\
        \    let hash = 0;\n    for (let i = 0; i < content.length; i++) {\n      const char = content.charCodeAt(i);\n  \
        \    hash = ((hash << 5) - hash) + char;\n      hash = hash & hash;\n    }\n    return Math.abs(hash).toString(16);\n\
        \  }\n  \n  shouldReportError(errorHash) {\n    if (this.reportCount >= this.maxReportsPerSession) {\n      return\
        \ false;\n    }\n    if (this.reportedErrors.has(errorHash)) {\n      return false;\n    }\n    return true;\n  }\n\
        }\n\n// Test the error reporter\nconst reporter = new JavaScriptErrorReporter({ enabled: true });\n\n// Test hash\
        \ computation\nconst hash1 = reporter.computeErrorHash('TypeError', 'Test error', 'test.js:10');\nconst hash2 = reporter.computeErrorHash('TypeError',\
        \ 'Test error', 'test.js:10');\nconst hash3 = reporter.computeErrorHash('TypeError', 'Different error', 'test.js:10');\n\
        \nif (hash1 !== hash2) {\n  console.error('\u274C Hash computation inconsistent');\n  process.exit(1);\n}\n\nif (hash1\
        \ === hash3) {\n  console.error('\u274C Hash not differentiating errors');\n  process.exit(1);\n}\n\nconsole.log('\u2705\
        \ Hash computation working correctly');\n\n// Test error deduplication\nif (!reporter.shouldReportError(hash1)) {\n\
        \  console.error('\u274C First error should be reported');\n  process.exit(1);\n}\n\nreporter.reportedErrors.add(hash1);\n\
        reporter.reportCount++;\n\nif (reporter.shouldReportError(hash1)) {\n  console.error('\u274C Duplicate error should\
        \ not be reported');\n  process.exit(1);\n}\n\nconsole.log('\u2705 Error deduplication working correctly');\n\n//\
        \ Test report limit\nfor (let i = 0; i < 20; i++) {\n  const testHash = `test_hash_${i}`;\n  if (reporter.shouldReportError(testHash))\
        \ {\n    reporter.reportedErrors.add(testHash);\n    reporter.reportCount++;\n  }\n}\n\nif (reporter.reportCount >\
        \ reporter.maxReportsPerSession) {\n  console.error('\u274C Report limit not enforced');\n  process.exit(1);\n}\n\n\
        console.log('\u2705 Report limit enforced correctly');\nconsole.log('\u2705 All JavaScript error reporter tests passed');\n\
        EOF\n\nnode test_error_reporter.js\n"
  sdk-browser-tests:
    runs-on:
    - self-hosted
    - linux
    - x64
    timeout-minutes: 45
    container:
      image: python:3.12-slim
      options: --user root
    needs:
    - sdk-static-analysis
    - sdk-functionality-tests
    if: ${{ !cancelled() && (github.event.inputs.test_mode == 'browser' || github.event.inputs.test_mode == 'comprehensive')
      }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 1
        submodules: false
    - name: Install browser testing dependencies
      run: 'apt-get update

        apt-get install -y chromium chromium-driver curl

        pip install --upgrade pip

        pip install -e .[test]

        pip install selenium

        '
    - name: Start MCP Dashboard
      run: "python -m ipfs_datasets_py.mcp_dashboard &\nMCP_PID=$!\necho \"MCP_DASHBOARD_PID=$MCP_PID\" >> $GITHUB_ENV\n\n\
        # Wait for dashboard\nfor i in {1..60}; do\n  if curl -f http://127.0.0.1:8899/api/health 2>/dev/null; then\n    echo\
        \ \"\u2705 Dashboard ready for browser tests!\"\n    break\n  fi\n  sleep 2\ndone\n"
    - name: Run Browser SDK Tests
      id: browser_tests
      continue-on-error: true
      run: "echo \"\U0001F310 Running browser-based SDK tests...\"\n\npython -c \"\nfrom selenium import webdriver\nfrom selenium.webdriver.chrome.options\
        \ import Options\nfrom selenium.webdriver.common.by import By\nfrom selenium.webdriver.support.ui import WebDriverWait\n\
        from selenium.webdriver.support import expected_conditions as EC\nimport time\n\n# Set up headless Chrome\noptions\
        \ = Options()\noptions.add_argument('--headless')\noptions.add_argument('--no-sandbox')\noptions.add_argument('--disable-dev-shm-usage')\n\
        options.add_argument('--disable-gpu')\n\ntry:\n    driver = webdriver.Chrome(options=options)\n    \n    # Navigate\
        \ to dashboard\n    driver.get('http://127.0.0.1:8899')\n    time.sleep(3)\n    \n    # Check if page loaded\n   \
        \ assert 'MCP' in driver.title or 'IPFS' in driver.title, 'Dashboard page did not load'\n    print('\u2705 Dashboard\
        \ page loaded successfully')\n    \n    # Execute JavaScript to test SDK loading\n    sdk_loaded = driver.execute_script('''\n\
        \        return typeof MCPClient !== 'undefined';\n    ''')\n    \n    if sdk_loaded:\n        print('\u2705 MCP SDK\
        \ loaded in browser')\n    else:\n        print('\u26A0\uFE0F MCP SDK not found in page (may be expected)')\n    \n\
        \    # Check for JavaScript errors in console\n    logs = driver.get_log('browser')\n    errors = [log for log in\
        \ logs if log['level'] == 'SEVERE']\n    \n    if errors:\n        print(f'\u26A0\uFE0F Found {len(errors)} JavaScript\
        \ errors:')\n        for error in errors[:5]:  # Show first 5\n            print(f'  - {error[\\\"message\\\"]}')\n\
        \    else:\n        print('\u2705 No JavaScript errors detected')\n    \n    driver.quit()\n    print('\u2705 Browser\
        \ SDK tests completed')\n    \nexcept Exception as e:\n    print(f'\u274C Browser tests failed: {e}')\n    import\
        \ traceback\n    traceback.print_exc()\n    exit(1)\n\" || echo \"browser_tests_failed=true\" >> $GITHUB_OUTPUT\n"
    - name: Stop Dashboard
      if: always()
      run: "if [ ! -z \"$MCP_DASHBOARD_PID\" ]; then\n  kill $MCP_DASHBOARD_PID || true\nfi\npkill -f \"mcp_dashboard\" ||\
        \ true\n"
  sdk-monitoring-summary:
    runs-on:
    - self-hosted
    - linux
    - x64
    timeout-minutes: 30
    container:
      image: python:3.12-slim
      options: --user root
    needs:
    - sdk-static-analysis
    - sdk-functionality-tests
    - js-error-reporter-test
    if: always()
    steps:
    - name: Generate SDK Monitoring Summary
      run: "echo \"## \U0001F4F1 JavaScript SDK Error Monitoring Results\" >> $GITHUB_STEP_SUMMARY\necho \"\" >> $GITHUB_STEP_SUMMARY\n\
        echo \"### Test Suite Results\" >> $GITHUB_STEP_SUMMARY\necho \"\" >> $GITHUB_STEP_SUMMARY\necho \"| Test Suite |\
        \ Status | Description |\" >> $GITHUB_STEP_SUMMARY\necho \"|------------|--------|-------------|\" >> $GITHUB_STEP_SUMMARY\n\
        echo \"| Static Analysis | ${{ needs.sdk-static-analysis.result }} | Linting and syntax checks |\" >> $GITHUB_STEP_SUMMARY\n\
        echo \"| Functionality Tests | ${{ needs.sdk-functionality-tests.result }} | SDK API integration tests |\" >> $GITHUB_STEP_SUMMARY\n\
        echo \"| Error Reporter Test | ${{ needs.js-error-reporter-test.result }} | JS error capture system |\" >> $GITHUB_STEP_SUMMARY\n\
        echo \"\" >> $GITHUB_STEP_SUMMARY\n\n# Add analysis\necho \"### Analysis\" >> $GITHUB_STEP_SUMMARY\necho \"\" >> $GITHUB_STEP_SUMMARY\n\
        \nif [ \"${{ needs.sdk-static-analysis.result }}\" = \"success\" ]; then\n  echo \"\u2705 **Static Analysis**: No\
        \ syntax or linting issues\" >> $GITHUB_STEP_SUMMARY\nelse\n  echo \"\u274C **Static Analysis**: Code quality issues\
        \ detected - auto-healing triggered\" >> $GITHUB_STEP_SUMMARY\nfi\n\nif [ \"${{ needs.sdk-functionality-tests.result\
        \ }}\" = \"success\" ]; then\n  echo \"\u2705 **Functionality**: SDK is working correctly\" >> $GITHUB_STEP_SUMMARY\n\
        else\n  echo \"\u26A0\uFE0F **Functionality**: SDK integration issues - auto-healing triggered\" >> $GITHUB_STEP_SUMMARY\n\
        fi\n\nif [ \"${{ needs.js-error-reporter-test.result }}\" = \"success\" ]; then\n  echo \"\u2705 **Error Reporter**:\
        \ JavaScript error capture is functional\" >> $GITHUB_STEP_SUMMARY\nelse\n  echo \"\u26A0\uFE0F **Error Reporter**:\
        \ Issues with JS error reporting\" >> $GITHUB_STEP_SUMMARY\nfi\n\necho \"\" >> $GITHUB_STEP_SUMMARY\necho \"### Auto-Healing\
        \ Integration\" >> $GITHUB_STEP_SUMMARY\necho \"- Failed workflows will trigger copilot-agent-autofix\" >> $GITHUB_STEP_SUMMARY\n\
        echo \"- GitHub issues will be created for detected JS errors\" >> $GITHUB_STEP_SUMMARY\necho \"- Draft PRs will be\
        \ generated with Copilot fixes\" >> $GITHUB_STEP_SUMMARY\n"
