name: Convert Issues to Draft PRs with Copilot
'on':
  issues:
    types:
    - opened
    - reopened
  workflow_dispatch:
    inputs:
      issue_number:
        description: Issue number to convert to draft PR
        required: true
        type: string
permissions:
  contents: write
  pull-requests: write
  issues: write
env:
  PYTHON_VERSION: '3.12'
jobs:
  create-draft-pr-with-copilot:
    runs-on:
    - self-hosted
    - linux
    - x64
    timeout-minutes: 45
    container:
      image: python:3.12-slim
      options: --user root
      volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    steps:
    - name: Debug issue information
      env:
        EVENT_NAME: ${{ github.event_name }}
        ISSUE_NUMBER: ${{ github.event.issue.number || github.event.inputs.issue_number }}
        ISSUE_TITLE: ${{ github.event.issue.title }}
        ISSUE_AUTHOR: ${{ github.event.issue.user.login }}
      run: |
        echo "## ðŸ” Issue to Draft PR Conversion" >> "$GITHUB_STEP_SUMMARY"
        echo "" >> "$GITHUB_STEP_SUMMARY"
        echo "### Event Information" >> "$GITHUB_STEP_SUMMARY"
        echo "- **Event Name**: $EVENT_NAME" >> "$GITHUB_STEP_SUMMARY"
        echo "- **Issue Number**: $ISSUE_NUMBER" >> "$GITHUB_STEP_SUMMARY"
        echo "- **Issue Title**: $ISSUE_TITLE" >> "$GITHUB_STEP_SUMMARY"
        echo "- **Issue Author**: $ISSUE_AUTHOR" >> "$GITHUB_STEP_SUMMARY"
        echo "" >> "$GITHUB_STEP_SUMMARY"
    - name: Install GitHub CLI and configure git
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        DEBIAN_FRONTEND: noninteractive
      run: 'apt-get update

        apt-get install -y git gh curl

        # Configure git for container environment

        # Note: Using ''*'' for safe.directory is required in containerized GitHub Actions

        # because the workspace path can vary. This is standard practice in GHA containers.

        git config --global --add safe.directory ''*''

        git config --global user.name "github-actions[bot]"

        git config --global user.email "github-actions[bot]@users.noreply.github.com"

        # Fix permissions for gh CLI config (container-specific requirement)

        # Note: This is needed for gh to read system CA certificates in the container

        chmod -R a+r /etc 2>/dev/null || true

        mkdir -p ~/.config/gh && chmod 700 ~/.config/gh

        '
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    - name: Configure GitHub CLI
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: '# Verify gh is authenticated

        gh auth status || echo "GH_TOKEN is set but gh auth status failed"

        gh auth setup-git

        '
    - name: Set up Python environment
      run: 'python --version

        python -m pip install --upgrade pip

        pip install PyYAML requests

        '
    - name: Get issue details
      id: get_issue
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: "# Get the issue number\nif [ \"${{ github.event_name }}\" = \"workflow_dispatch\" ]; then\n  ISSUE_NUMBER=\"${{\
        \ github.event.inputs.issue_number }}\"\nelse\n  ISSUE_NUMBER=\"${{ github.event.issue.number }}\"\nfi\n\necho \"\
        Processing issue #$ISSUE_NUMBER\"\n\n# Get issue details\nISSUE_DATA=$(gh issue view \"$ISSUE_NUMBER\" --repo ${{\
        \ github.repository }} --json title,body,number,author,labels)\n\nISSUE_TITLE=$(echo \"$ISSUE_DATA\" | python -c \"\
        import sys, json; print(json.load(sys.stdin)['title'])\")\nISSUE_AUTHOR=$(echo \"$ISSUE_DATA\" | python -c \"import\
        \ sys, json; print(json.load(sys.stdin)['author']['login'])\")\nISSUE_BODY=$(echo \"$ISSUE_DATA\" | python -c \"import\
        \ sys, json; print(json.load(sys.stdin).get('body', ''))\")\n\necho \"issue_number=$ISSUE_NUMBER\" >> $GITHUB_OUTPUT\n\
        echo \"issue_title=$ISSUE_TITLE\" >> $GITHUB_OUTPUT\necho \"issue_author=$ISSUE_AUTHOR\" >> $GITHUB_OUTPUT\n\n# Save\
        \ issue body to file for later use\necho \"$ISSUE_BODY\" > /tmp/issue_body.txt\n\n# Check if this is an auto-generated\
        \ issue from auto-healing system\nif echo \"$ISSUE_TITLE\" | grep -qE \"^Fix:|workflow failure\"; then\n  if echo\
        \ \"$ISSUE_BODY\" | grep -qE \"Auto-generated|auto-healing|automated workflow\"; then\n    echo \"\u26A0\uFE0F  This\
        \ is an auto-generated issue from the auto-healing system\"\n    echo \"\u26A0\uFE0F  Skipping to avoid duplicate\
        \ PRs (auto-healing creates its own PRs)\"\n    echo \"is_auto_generated=true\" >> $GITHUB_OUTPUT\n    \n    echo\
        \ \"## \u23ED\uFE0F Skipping Auto-Generated Issue\" >> $GITHUB_STEP_SUMMARY\n    echo \"\" >> $GITHUB_STEP_SUMMARY\n\
        \    echo \"This issue was auto-generated by the auto-healing system.\" >> $GITHUB_STEP_SUMMARY\n    echo \"The auto-healing\
        \ system creates its own PRs, so we skip this to avoid duplicates.\" >> $GITHUB_STEP_SUMMARY\n    echo \"- **Issue**:\
        \ #$ISSUE_NUMBER\" >> $GITHUB_STEP_SUMMARY\n    echo \"- **Reason**: Auto-generated by copilot-agent-autofix workflow\"\
        \ >> $GITHUB_STEP_SUMMARY\n    exit 0\n  fi\nfi\n\necho \"is_auto_generated=false\" >> $GITHUB_OUTPUT\n\necho \"##\
        \ Issue Details\" >> $GITHUB_STEP_SUMMARY\necho \"\" >> $GITHUB_STEP_SUMMARY\necho \"- **Issue Number**: #$ISSUE_NUMBER\"\
        \ >> $GITHUB_STEP_SUMMARY\necho \"- **Title**: $ISSUE_TITLE\" >> $GITHUB_STEP_SUMMARY\necho \"- **Author**: @$ISSUE_AUTHOR\"\
        \ >> $GITHUB_STEP_SUMMARY\n"
    - name: Check for existing draft PR
      id: check_existing
      if: steps.get_issue.outputs.is_auto_generated != 'true'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: "ISSUE_NUMBER=\"${{ steps.get_issue.outputs.issue_number }}\"\n\n# Check if there's already a PR for this issue\n\
        echo \"Searching for existing PRs for issue #$ISSUE_NUMBER\"\nEXISTING_PRS=$(gh pr list --repo ${{ github.repository\
        \ }} --search \"Fixes #$ISSUE_NUMBER in:body\" --state all --json number --jq 'length' 2>&1 || echo \"0\")\n\necho\
        \ \"Found $EXISTING_PRS existing PRs\"\n\nif [ \"$EXISTING_PRS\" -gt 0 ]; then\n  echo \"\u26A0\uFE0F  Issue #$ISSUE_NUMBER\
        \ already has $EXISTING_PRS PR(s) - skipping duplicate\"\n  echo \"should_skip=true\" >> $GITHUB_OUTPUT\n  echo \"\
        skip_reason=pr_exists\" >> $GITHUB_OUTPUT\n  \n  echo \"## \u23ED\uFE0F Skipping Duplicate PR Creation\" >> $GITHUB_STEP_SUMMARY\n\
        \  echo \"\" >> $GITHUB_STEP_SUMMARY\n  echo \"This issue already has existing PR(s).\" >> $GITHUB_STEP_SUMMARY\n\
        \  echo \"- **Issue**: #$ISSUE_NUMBER\" >> $GITHUB_STEP_SUMMARY\n  echo \"- **Existing PRs**: $EXISTING_PRS\" >> $GITHUB_STEP_SUMMARY\n\
        \  exit 0\nfi\n\n# Check rate limiting - count recent draft PRs created by this workflow\necho \"Checking rate limits...\"\
        \nRECENT_DRAFT_PRS=$(gh pr list --repo ${{ github.repository }} --state open --draft --json createdAt,author --jq\
        \ '[.[] | select(.author.login == \"github-actions[bot]\" and .createdAt > (now - 3600 | strftime(\"%Y-%m-%dT%H:%M:%SZ\"\
        )))] | length' 2>&1 || echo \"0\")\n\necho \"Recent draft PRs created in last hour: $RECENT_DRAFT_PRS\"\n\nif [ \"\
        $RECENT_DRAFT_PRS\" -ge 10 ]; then\n  echo \"\u26A0\uFE0F  Rate limit reached: $RECENT_DRAFT_PRS draft PRs created\
        \ in last hour\"\n  echo \"\u26A0\uFE0F  Maximum allowed is 10 per hour to prevent spam\"\n  echo \"should_skip=true\"\
        \ >> $GITHUB_OUTPUT\n  echo \"skip_reason=rate_limit\" >> $GITHUB_OUTPUT\n  \n  echo \"## \u23ED\uFE0F Rate Limit\
        \ Reached\" >> $GITHUB_STEP_SUMMARY\n  echo \"\" >> $GITHUB_STEP_SUMMARY\n  echo \"Too many draft PRs created recently.\
        \ Skipping to prevent spam.\" >> $GITHUB_STEP_SUMMARY\n  echo \"- **Recent draft PRs**: $RECENT_DRAFT_PRS\" >> $GITHUB_STEP_SUMMARY\n\
        \  echo \"- **Limit**: 10 per hour\" >> $GITHUB_STEP_SUMMARY\n  echo \"- **Issue**: #$ISSUE_NUMBER will be processed\
        \ later\" >> $GITHUB_STEP_SUMMARY\n  exit 0\nfi\n\necho \"should_skip=false\" >> $GITHUB_OUTPUT\n"
    - name: Generate branch name and PR details
      id: generate_details
      if: steps.get_issue.outputs.is_auto_generated != 'true' && steps.check_existing.outputs.should_skip != 'true'
      env:
        ISSUE_NUMBER: ${{ steps.get_issue.outputs.issue_number }}
        ISSUE_TITLE: ${{ steps.get_issue.outputs.issue_title }}
      run: '# Create a clean branch name from issue title

        BRANCH_NAME=$(echo "issue-${ISSUE_NUMBER}/$(echo "$ISSUE_TITLE" | tr ''[:upper:]'' ''[:lower:]'' | sed ''s/[^a-z0-9]/-/g''
        | sed ''s/--*/-/g'' | cut -c1-50 | sed ''s/-$//'')")


        # Generate PR title

        PR_TITLE="Fix: $ISSUE_TITLE"


        echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

        echo "pr_title=$PR_TITLE" >> $GITHUB_OUTPUT


        echo "## Generated Details" >> $GITHUB_STEP_SUMMARY

        echo "" >> $GITHUB_STEP_SUMMARY

        echo "- **Branch**: \`$BRANCH_NAME\`" >> $GITHUB_STEP_SUMMARY

        echo "- **PR Title**: $PR_TITLE" >> $GITHUB_STEP_SUMMARY

        '
    - name: Analyze issue and create task file
      id: analyze_issue
      if: steps.get_issue.outputs.is_auto_generated != 'true' && steps.check_existing.outputs.should_skip != 'true'
      run: "ISSUE_NUMBER=\"${{ steps.get_issue.outputs.issue_number }}\"\nISSUE_TITLE=\"${{ steps.get_issue.outputs.issue_title\
        \ }}\"\n\n# Create analysis of the issue\npython3 << 'PYTHON_EOF'\nimport json\nimport re\n\n# Read issue body\nwith\
        \ open('/tmp/issue_body.txt', 'r') as f:\n    issue_body = f.read()\n\n# Extract key information\nanalysis = {\n \
        \   'issue_number': '${{ steps.get_issue.outputs.issue_number }}',\n    'issue_title': '${{ steps.get_issue.outputs.issue_title\
        \ }}',\n    'categories': [],\n    'keywords': [],\n    'complexity': 'medium',\n    'estimated_effort': 'moderate'\n\
        }\n\n# Categorize based on keywords\nkeywords_map = {\n    'bug': ['bug', 'error', 'broken', 'fail', 'crash', 'exception'],\n\
        \    'feature': ['feature', 'add', 'implement', 'support', 'new'],\n    'documentation': ['doc', 'readme', 'guide',\
        \ 'tutorial', 'documentation'],\n    'test': ['test', 'testing', 'coverage', 'spec'],\n    'ci/cd': ['workflow', 'ci',\
        \ 'cd', 'pipeline', 'action'],\n    'dependency': ['dependency', 'package', 'version', 'upgrade'],\n    'performance':\
        \ ['performance', 'slow', 'optimization', 'speed']\n}\n\nissue_text = (issue_body + ' ' + '${{ steps.get_issue.outputs.issue_title\
        \ }}').lower()\n\nfor category, keywords in keywords_map.items():\n    if any(kw in issue_text for kw in keywords):\n\
        \        analysis['categories'].append(category)\n        analysis['keywords'].extend([kw for kw in keywords if kw\
        \ in issue_text])\n\n# Default category if none detected\nif not analysis['categories']:\n    analysis['categories']\
        \ = ['general']\n\n# Save analysis\nwith open('/tmp/issue_analysis.json', 'w') as f:\n    json.dump(analysis, f, indent=2)\n\
        \nprint(f\"Analysis complete: {analysis['categories']}\")\nPYTHON_EOF\n\necho \"analysis_complete=true\" >> $GITHUB_OUTPUT\n\
        \n# Show analysis\necho \"\" >> $GITHUB_STEP_SUMMARY\necho \"## Issue Analysis\" >> $GITHUB_STEP_SUMMARY\npython3\
        \ -c \"\nimport json\nwith open('/tmp/issue_analysis.json') as f:\n    data = json.load(f)\n    print('- **Categories**:\
        \ ' + ', '.join(data['categories']))\n    print('- **Complexity**: ' + data['complexity'])\n    print('- **Estimated\
        \ Effort**: ' + data['estimated_effort'])\n\" >> $GITHUB_STEP_SUMMARY\n"
    - name: Create draft PR branch and commit
      id: create_branch
      if: steps.get_issue.outputs.is_auto_generated != 'true' && steps.check_existing.outputs.should_skip != 'true'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: "ISSUE_NUMBER=\"${{ steps.get_issue.outputs.issue_number }}\"\nBRANCH_NAME=\"${{ steps.generate_details.outputs.branch_name\
        \ }}\"\n\n# Configure git\ngit config user.name \"github-actions[bot]\"\ngit config user.email \"41898282+github-actions[bot]@users.noreply.github.com\"\
        \n\n# Get default branch\nDEFAULT_BRANCH=$(git rev-parse --abbrev-ref HEAD)\necho \"Default branch: $DEFAULT_BRANCH\"\
        \n\n# Create and checkout new branch\ngit checkout -b \"$BRANCH_NAME\"\n\n# Create README for the PR\ncat > ISSUE_${ISSUE_NUMBER}_README.md\
        \ << 'README_EOF'\n# Automated Issue Resolution\n\nThis branch was created automatically to address issue #${{ steps.get_issue.outputs.issue_number\
        \ }}.\n\n## Issue Details\n\n**Title**: ${{ steps.get_issue.outputs.issue_title }}\n**Author**: @${{ steps.get_issue.outputs.issue_author\
        \ }}\n**Link**: https://github.com/${{ github.repository }}/issues/${{ steps.get_issue.outputs.issue_number }}\n\n\
        ## Description\n\nREADME_EOF\n\n# Add issue body\ncat /tmp/issue_body.txt >> ISSUE_${ISSUE_NUMBER}_README.md\n\ncat\
        \ >> ISSUE_${ISSUE_NUMBER}_README.md << 'README_EOF'\n\n## Next Steps\n\nGitHub Copilot will automatically analyze\
        \ this issue and implement the necessary changes.\n\n@copilot will be mentioned in the PR to trigger the automated\
        \ implementation.\n\n---\n\n\U0001F916 *This file was auto-generated by the Issue-to-Draft-PR workflow*\nREADME_EOF\n\
        \ngit add ISSUE_${ISSUE_NUMBER}_README.md\ngit commit -m \"chore: Initialize branch for issue #$ISSUE_NUMBER\n\nThis\
        \ commit creates a branch for automated resolution of:\n${{ steps.get_issue.outputs.issue_title }}\n\nRelated Issue:\
        \ #$ISSUE_NUMBER\nAuthor: @${{ steps.get_issue.outputs.issue_author }}\"\n\ngit push origin \"$BRANCH_NAME\"\n\necho\
        \ \"branch_created=true\" >> $GITHUB_OUTPUT\necho \"default_branch=$DEFAULT_BRANCH\" >> $GITHUB_OUTPUT\n"
    - name: Create draft PR with Copilot mention
      id: create_pr
      if: steps.create_branch.outputs.branch_created == 'true'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        ISSUE_AUTHOR: ${{ steps.get_issue.outputs.issue_author }}
      run: "ISSUE_NUMBER=\"${{ steps.get_issue.outputs.issue_number }}\"\nBRANCH_NAME=\"${{ steps.generate_details.outputs.branch_name\
        \ }}\"\nPR_TITLE=\"${{ steps.generate_details.outputs.pr_title }}\"\nDEFAULT_BRANCH=\"${{ steps.create_branch.outputs.default_branch\
        \ }}\"\n\n# Create PR body\n# Export outputs to environment variables\nISSUE_NUMBER=\"${{ steps.get_issue.outputs.issue_number\
        \ }}\"\nISSUE_TITLE=\"${{ steps.get_issue.outputs.issue_title }}\"\n# ISSUE_AUTHOR is available as $ISSUE_AUTHOR via\
        \ env (see above)\ncat > /tmp/pr_body.md <<'PR_EOF'\n## \U0001F916 Automated Issue Resolution\n\nThis PR addresses\
        \ issue #$ISSUE_NUMBER.\n\n### Related Issue\n\nFixes #$ISSUE_NUMBER\n### Issue Summary\n\n**Title**: $ISSUE_TITLE\n\
        **Author**: @$ISSUE_AUTHOR\n\n### Original Issue Description\n\nPR_EOF\n\n# Add issue body\ncat /tmp/issue_body.txt\
        \ >> /tmp/pr_body.md\n\ncat >> /tmp/pr_body.md << 'PR_EOF'\n\n### Analysis\n\nPR_EOF\n\n# Add analysis\npython3 -c\
        \ \"\nimport json\nwith open('/tmp/issue_analysis.json') as f:\n    data = json.load(f)\n    print('- **Categories**:\
        \ ' + ', '.join(data['categories']))\n    print('- **Complexity**: ' + data['complexity'])\n    print('- **Keywords**:\
        \ ' + ', '.join(data.get('keywords', [])[:5]))\n\" >> /tmp/pr_body.md\n\ncat >> /tmp/pr_body.md << 'PR_EOF'\n\n###\
        \ What This PR Does\n\nThis is a draft PR that will be automatically updated by GitHub Copilot to resolve the issue.\n\
        \nGitHub Copilot will be invoked automatically using the Copilot CLI tool to implement the necessary changes.\n\n\
        Focus on:\n- Understanding the problem described in the issue\n- Implementing a minimal, surgical fix\n- Adding or\
        \ updating tests as appropriate\n- Following the existing code style and patterns\n- Documenting any significant changes\n\
        \n### Task Checklist\n\n- [ ] Analyze the issue requirements\n- [ ] Implement the solution\n- [ ] Add/update tests\n\
        - [ ] Update documentation if needed\n- [ ] Verify the fix works as expected\n\n---\n\n\U0001F916 **Auto-generated\
        \ by**: Issue-to-Draft-PR Workflow\n**Issue**: #${{ steps.get_issue.outputs.issue_number }}\n**Workflow Run**: [${{\
        \ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\nPR_EOF\n\n# Create\
        \ draft PR\nset +e  # Don't exit on error\nPR_URL=$(gh pr create \\\n  --draft \\\n  --title \"$PR_TITLE\" \\\n  --body-file\
        \ /tmp/pr_body.md \\\n  --base \"$DEFAULT_BRANCH\" \\\n  --head \"$BRANCH_NAME\" 2>&1)\nPR_CREATE_EXIT=$?\nset -e\
        \  # Re-enable exit on error\n\nif [ $PR_CREATE_EXIT -eq 0 ]; then\n  PR_NUMBER=$(echo \"$PR_URL\" | grep -oP '\\\
        d+$')\n  echo \"pr_url=$PR_URL\" >> $GITHUB_OUTPUT\n  echo \"pr_number=$PR_NUMBER\" >> $GITHUB_OUTPUT\n  echo \"\u2705\
        \ Successfully created PR #$PR_NUMBER\"\n  \n  # Invoke Copilot using the verified dual method (draft PR + @copilot\
        \ trigger)\n  # This is the ONLY method with 100% success rate\n  echo \"Invoking GitHub Copilot on PR #$PR_NUMBER\
        \ using verified dual method...\"\n  \n  # Always use the JSON context file which safely contains issue details\n\
        \  # The issue analysis JSON is created earlier and contains sanitized data\n  if [ -f \"/tmp/issue_analysis.json\"\
        \ ]; then\n    # Read issue details from JSON\n    ISSUE_TITLE=$(jq -r '.title // \"Implement solution\"' /tmp/issue_analysis.json)\n\
        \    ISSUE_BODY=$(jq -r '.body // \"See issue for details\"' /tmp/issue_analysis.json | head -c 500)\n    \n    python3\
        \ scripts/invoke_copilot_on_pr.py \\\n      --pr \"$PR_NUMBER\" \\\n      --instruction \"Please implement a solution\
        \ for issue #$ISSUE_NUMBER: $ISSUE_TITLE. Details: $ISSUE_BODY. Review the full issue description in the PR and implement\
        \ minimal, surgical changes.\" \\\n      || echo \"\u26A0\uFE0F  Copilot invocation failed, check logs\"\n  else\n\
        \    # Fallback to basic instruction without user-controlled content\n    python3 scripts/invoke_copilot_on_pr.py\
        \ \\\n      --pr \"$PR_NUMBER\" \\\n      --instruction \"Please implement a solution for this issue. Review the full\
        \ issue description in the PR and implement minimal, surgical changes.\" \\\n      || echo \"\u26A0\uFE0F  Copilot\
        \ invocation failed, check logs\"\n  fi\n  \n  # Link PR back to issue\n  gh issue comment \"$ISSUE_NUMBER\" --repo\
        \ ${{ github.repository }} --body \"\U0001F916 **Automatic Draft PR Created**\n\nA draft PR has been created to address\
        \ this issue: #$PR_NUMBER\n\nGitHub Copilot has been assigned and will implement the solution automatically.\n\n**PR**:\
        \ $PR_URL\n**Branch**: \\`$BRANCH_NAME\\`\n\nYou can monitor the progress in the draft PR. The PR will be ready for\
        \ review once Copilot completes the implementation.\"\n  \n  echo \"\" >> $GITHUB_STEP_SUMMARY\n  echo \"## \u2705\
        \ Draft PR Created Successfully\" >> $GITHUB_STEP_SUMMARY\n  echo \"\" >> $GITHUB_STEP_SUMMARY\n  echo \"\U0001F517\
        \ **Issue**: #$ISSUE_NUMBER\" >> $GITHUB_STEP_SUMMARY\n  echo \"\U0001F517 **PR**: $PR_URL\" >> $GITHUB_STEP_SUMMARY\n\
        \  echo \"\U0001F522 **PR Number**: #$PR_NUMBER\" >> $GITHUB_STEP_SUMMARY\n  echo \"\U0001F33F **Branch**: \\`$BRANCH_NAME\\\
        `\" >> $GITHUB_STEP_SUMMARY\n  echo \"\U0001F916 **Status**: GitHub Copilot invoked via verified dual method (draft\
        \ PR + @copilot trigger)\" >> $GITHUB_STEP_SUMMARY\nelse\n  echo \"\u26A0\uFE0F Could not create PR automatically\
        \ (permission denied or other error)\"\n  echo \"Error: $PR_URL\"\n  echo \"pr_url=\" >> $GITHUB_OUTPUT\n  echo \"\
        pr_number=\" >> $GITHUB_OUTPUT\n  \n  # Update issue with manual PR creation instructions\n  gh issue comment \"$ISSUE_NUMBER\"\
        \ --repo ${{ github.repository }} --body \"\u26A0\uFE0F **Automatic PR creation failed**\n\nThe branch has been created:\
        \ \\`$BRANCH_NAME\\`\n\n**To create the PR manually**:\n1. Go to: https://github.com/${{ github.repository }}/compare/${DEFAULT_BRANCH}...$BRANCH_NAME\n\
        2. Click 'Create pull request'\n3. Mark it as a draft\n4. Use the invoke_copilot_on_pr.py script to invoke GitHub\
        \ Copilot:\n   \\`\\`\\`bash\n   python3 scripts/invoke_copilot_on_pr.py --pr <PR_NUMBER>\n   \\`\\`\\`\n\n**Or enable\
        \ automatic PR creation**:\n1. Go to Settings \u2192 Actions \u2192 General \u2192 Workflow permissions\n2. Select\
        \ 'Read and write permissions'\n3. Check 'Allow GitHub Actions to create and approve pull requests'\"\n  \n  echo\
        \ \"\" >> $GITHUB_STEP_SUMMARY\n  echo \"## \u26A0\uFE0F PR Creation Failed\" >> $GITHUB_STEP_SUMMARY\n  echo \"\"\
        \ >> $GITHUB_STEP_SUMMARY\n  echo \"\U0001F517 **Issue**: #$ISSUE_NUMBER\" >> $GITHUB_STEP_SUMMARY\n  echo \"\U0001F33F\
        \ **Branch**: \\`$BRANCH_NAME\\`\" >> $GITHUB_STEP_SUMMARY\n  echo \"\u26A0\uFE0F **Note**: See issue for manual PR\
        \ creation steps\" >> $GITHUB_STEP_SUMMARY\nfi\n"
    - name: Summary
      if: always()
      env:
        SKIP_REASON: ${{ steps.check_existing.outputs.skip_reason }}
        ISSUE_NUMBER: ${{ steps.get_issue.outputs.issue_number }}
        BRANCH_CREATED: ${{ steps.create_branch.outputs.branch_created }}
        PR_CREATED: ${{ steps.create_pr.outputs.pr_number }}
        BRANCH_NAME: ${{ steps.generate_details.outputs.branch_name }}
      run: "echo \"\" >> $GITHUB_STEP_SUMMARY\necho \"---\" >> $GITHUB_STEP_SUMMARY\necho \"\" >> $GITHUB_STEP_SUMMARY\n\n\
        if [ \"${{ steps.check_existing.outputs.should_skip }}\" = \"true\" ]; then\n  echo \"### \u23ED\uFE0F Skipped\" >>\
        \ $GITHUB_STEP_SUMMARY\n  echo \"- \U0001F50D Reason: $SKIP_REASON\" >> $GITHUB_STEP_SUMMARY\nelse\n  echo \"### \U0001F916\
        \ Issue-to-PR Conversion Status\" >> $GITHUB_STEP_SUMMARY\n  echo \"- \U0001F4DD Issue: #$ISSUE_NUMBER\" >> $GITHUB_STEP_SUMMARY\n\
        \  echo \"- \U0001F33F Branch Created: $BRANCH_CREATED\" >> $GITHUB_STEP_SUMMARY\n  if [ -n \"$PR_CREATED\" ]; then\n\
        \    echo \"- \U0001F4CB PR Created: true\" >> $GITHUB_STEP_SUMMARY\n  else\n    echo \"- \U0001F4CB PR Created: false\"\
        \ >> $GITHUB_STEP_SUMMARY\n  fi\n  \n  if [ -n \"$PR_CREATED\" ]; then\n    echo \"\" >> $GITHUB_STEP_SUMMARY\n  \
        \  echo \"#### \u2705 Success!\" >> $GITHUB_STEP_SUMMARY\n    echo \"- **Issue**: #$ISSUE_NUMBER\" >> $GITHUB_STEP_SUMMARY\n\
        \    echo \"- **Draft PR**: #$PR_CREATED\" >> $GITHUB_STEP_SUMMARY\n    echo \"- **Branch**: \\`$BRANCH_NAME\\`\"\
        \ >> $GITHUB_STEP_SUMMARY\n    echo \"- **Status**: GitHub Copilot assigned via @mention\" >> $GITHUB_STEP_SUMMARY\n\
        \    echo \"\" >> $GITHUB_STEP_SUMMARY\n    echo \"**Next**: Monitor PR #$PR_CREATED for Copilot's implementation\"\
        \ >> $GITHUB_STEP_SUMMARY\n  fi\nfi\n"
    - name: Upload artifacts
      if: always() && steps.analyze_issue.outputs.analysis_complete == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: issue-to-pr-${{ steps.get_issue.outputs.issue_number }}
        path: '/tmp/issue_body.txt

          /tmp/issue_analysis.json

          /tmp/pr_body.md

          '
        retention-days: 30
