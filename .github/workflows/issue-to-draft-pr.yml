name: Convert Issues to Draft PRs with Copilot
'on':
  issues:
    types:
    - opened
    - reopened
  workflow_dispatch:
    inputs:
      issue_number:
        description: Issue number to convert to draft PR
        required: true
        type: string
permissions:
  contents: write
  pull-requests: write
  issues: write
env:
  PYTHON_VERSION: '3.12'
jobs:
  create-draft-pr-with-copilot:
    runs-on:
    - self-hosted
    - linux
    - x64
    timeout-minutes: 45
    container:
      image: python:3.12-slim
      options: --user root
      volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    steps:
    - name: Debug issue information
      env:
        EVENT_NAME: ${{ github.event_name }}
        ISSUE_NUMBER: ${{ github.event.issue.number || github.event.inputs.issue_number }}
        ISSUE_TITLE: ${{ github.event.issue.title }}
        ISSUE_AUTHOR: ${{ github.event.issue.user.login }}
      run: |
        echo "## üîç Issue to Draft PR Conversion" >> "$GITHUB_STEP_SUMMARY"
        echo "" >> "$GITHUB_STEP_SUMMARY"
        echo "### Event Information" >> "$GITHUB_STEP_SUMMARY"
        echo "- **Event Name**: $EVENT_NAME" >> "$GITHUB_STEP_SUMMARY"
        echo "- **Issue Number**: $ISSUE_NUMBER" >> "$GITHUB_STEP_SUMMARY"
        echo "- **Issue Title**: $ISSUE_TITLE" >> "$GITHUB_STEP_SUMMARY"
        echo "- **Issue Author**: $ISSUE_AUTHOR" >> "$GITHUB_STEP_SUMMARY"
        echo "" >> "$GITHUB_STEP_SUMMARY"
    - name: Install GitHub CLI and configure git
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        DEBIAN_FRONTEND: noninteractive
      run: 'apt-get update

        apt-get install -y git gh curl

        # Configure git for container environment

        # Note: Using ''*'' for safe.directory is required in containerized GitHub Actions

        # because the workspace path can vary. This is standard practice in GHA containers.

        git config --global --add safe.directory ''*''

        git config --global user.name "github-actions[bot]"

        git config --global user.email "github-actions[bot]@users.noreply.github.com"

        # Fix permissions for gh CLI config (container-specific requirement)

        # Note: This is needed for gh to read system CA certificates in the container

        chmod -R a+r /etc 2>/dev/null || true

        mkdir -p ~/.config/gh && chmod 700 ~/.config/gh

        '
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    - name: Configure GitHub CLI
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: '# Verify gh is authenticated

        gh auth status || echo "GH_TOKEN is set but gh auth status failed"

        gh auth setup-git

        '
    - name: Set up Python environment
      run: 'python --version

        python -m pip install --upgrade pip

        pip install PyYAML requests

        '
    - name: Get issue details
      id: get_issue
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: "# Get the issue number\nif [ \"${{ github.event_name }}\" = \"workflow_dispatch\" ]; then\n  ISSUE_NUMBER=\"${{\
        \ github.event.inputs.issue_number }}\"\nelse\n  ISSUE_NUMBER=\"${{ github.event.issue.number }}\"\nfi\n\necho \"\
        Processing issue #$ISSUE_NUMBER\"\n\n# Get issue details\nISSUE_DATA=$(gh issue view \"$ISSUE_NUMBER\" --repo ${{\
        \ github.repository }} --json title,body,number,author,labels)\n\nISSUE_TITLE=$(echo \"$ISSUE_DATA\" | python -c \"\
        import sys, json; print(json.load(sys.stdin)['title'])\")\nISSUE_AUTHOR=$(echo \"$ISSUE_DATA\" | python -c \"import\
        \ sys, json; print(json.load(sys.stdin)['author']['login'])\")\nISSUE_BODY=$(echo \"$ISSUE_DATA\" | python -c \"import\
        \ sys, json; print(json.load(sys.stdin).get('body', ''))\")\n\necho \"issue_number=$ISSUE_NUMBER\" >> $GITHUB_OUTPUT\n\
        echo \"issue_title=$ISSUE_TITLE\" >> $GITHUB_OUTPUT\necho \"issue_author=$ISSUE_AUTHOR\" >> $GITHUB_OUTPUT\n\n# Save\
        \ issue body to file for later use\necho \"$ISSUE_BODY\" > /tmp/issue_body.txt\n\n# Check if this is an auto-generated\
        \ issue from auto-healing system\nif echo \"$ISSUE_TITLE\" | grep -qE \"^Fix:|workflow failure\"; then\n  if echo\
        \ \"$ISSUE_BODY\" | grep -qE \"Auto-generated|auto-healing|automated workflow\"; then\n    echo \"\u26A0\uFE0F  This\
        \ is an auto-generated issue from the auto-healing system\"\n    echo \"\u26A0\uFE0F  Skipping to avoid duplicate\
        \ PRs (auto-healing creates its own PRs)\"\n    echo \"is_auto_generated=true\" >> $GITHUB_OUTPUT\n    \n    echo\
        \ \"## \u23ED\uFE0F Skipping Auto-Generated Issue\" >> $GITHUB_STEP_SUMMARY\n    echo \"\" >> $GITHUB_STEP_SUMMARY\n\
        \    echo \"This issue was auto-generated by the auto-healing system.\" >> $GITHUB_STEP_SUMMARY\n    echo \"The auto-healing\
        \ system creates its own PRs, so we skip this to avoid duplicates.\" >> $GITHUB_STEP_SUMMARY\n    echo \"- **Issue**:\
        \ #$ISSUE_NUMBER\" >> $GITHUB_STEP_SUMMARY\n    echo \"- **Reason**: Auto-generated by copilot-agent-autofix workflow\"\
        \ >> $GITHUB_STEP_SUMMARY\n    exit 0\n  fi\nfi\n\necho \"is_auto_generated=false\" >> $GITHUB_OUTPUT\n\necho \"##\
        \ Issue Details\" >> $GITHUB_STEP_SUMMARY\necho \"\" >> $GITHUB_STEP_SUMMARY\necho \"- **Issue Number**: #$ISSUE_NUMBER\"\
        \ >> $GITHUB_STEP_SUMMARY\necho \"- **Title**: $ISSUE_TITLE\" >> $GITHUB_STEP_SUMMARY\necho \"- **Author**: @$ISSUE_AUTHOR\"\
        \ >> $GITHUB_STEP_SUMMARY\n"
    - name: Check for existing draft PR
      id: check_existing
      if: steps.get_issue.outputs.is_auto_generated != 'true'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: "ISSUE_NUMBER=\"${{ steps.get_issue.outputs.issue_number }}\"\n\n# Check if there's already a PR for this issue\n\
        echo \"Searching for existing PRs for issue #$ISSUE_NUMBER\"\nEXISTING_PRS=$(gh pr list --repo ${{ github.repository\
        \ }} --search \"Fixes #$ISSUE_NUMBER in:body\" --state all --json number --jq 'length' 2>&1 || echo \"0\")\n\necho\
        \ \"Found $EXISTING_PRS existing PRs\"\n\nif [ \"$EXISTING_PRS\" -gt 0 ]; then\n  echo \"\u26A0\uFE0F  Issue #$ISSUE_NUMBER\
        \ already has $EXISTING_PRS PR(s) - skipping duplicate\"\n  echo \"should_skip=true\" >> $GITHUB_OUTPUT\n  echo \"\
        skip_reason=pr_exists\" >> $GITHUB_OUTPUT\n  \n  echo \"## \u23ED\uFE0F Skipping Duplicate PR Creation\" >> $GITHUB_STEP_SUMMARY\n\
        \  echo \"\" >> $GITHUB_STEP_SUMMARY\n  echo \"This issue already has existing PR(s).\" >> $GITHUB_STEP_SUMMARY\n\
        \  echo \"- **Issue**: #$ISSUE_NUMBER\" >> $GITHUB_STEP_SUMMARY\n  echo \"- **Existing PRs**: $EXISTING_PRS\" >> $GITHUB_STEP_SUMMARY\n\
        \  exit 0\nfi\n\n# Check rate limiting - count recent draft PRs created by this workflow\necho \"Checking rate limits...\"\
        \nRECENT_DRAFT_PRS=$(gh pr list --repo ${{ github.repository }} --state open --draft --json createdAt,author --jq\
        \ '[.[] | select(.author.login == \"github-actions[bot]\" and .createdAt > (now - 3600 | strftime(\"%Y-%m-%dT%H:%M:%SZ\"\
        )))] | length' 2>&1 || echo \"0\")\n\necho \"Recent draft PRs created in last hour: $RECENT_DRAFT_PRS\"\n\nif [ \"\
        $RECENT_DRAFT_PRS\" -ge 10 ]; then\n  echo \"\u26A0\uFE0F  Rate limit reached: $RECENT_DRAFT_PRS draft PRs created\
        \ in last hour\"\n  echo \"\u26A0\uFE0F  Maximum allowed is 10 per hour to prevent spam\"\n  echo \"should_skip=true\"\
        \ >> $GITHUB_OUTPUT\n  echo \"skip_reason=rate_limit\" >> $GITHUB_OUTPUT\n  \n  echo \"## \u23ED\uFE0F Rate Limit\
        \ Reached\" >> $GITHUB_STEP_SUMMARY\n  echo \"\" >> $GITHUB_STEP_SUMMARY\n  echo \"Too many draft PRs created recently.\
        \ Skipping to prevent spam.\" >> $GITHUB_STEP_SUMMARY\n  echo \"- **Recent draft PRs**: $RECENT_DRAFT_PRS\" >> $GITHUB_STEP_SUMMARY\n\
        \  echo \"- **Limit**: 10 per hour\" >> $GITHUB_STEP_SUMMARY\n  echo \"- **Issue**: #$ISSUE_NUMBER will be processed\
        \ later\" >> $GITHUB_STEP_SUMMARY\n  exit 0\nfi\n\necho \"should_skip=false\" >> $GITHUB_OUTPUT\n"
    - name: Generate branch name and PR details
      id: generate_details
      if: steps.get_issue.outputs.is_auto_generated != 'true' && steps.check_existing.outputs.should_skip != 'true'
      env:
        ISSUE_NUMBER: ${{ steps.get_issue.outputs.issue_number }}
        ISSUE_TITLE: ${{ steps.get_issue.outputs.issue_title }}
      run: '# Create a clean branch name from issue title

        BRANCH_NAME=$(echo "issue-${ISSUE_NUMBER}/$(echo "$ISSUE_TITLE" | tr ''[:upper:]'' ''[:lower:]'' | sed ''s/[^a-z0-9]/-/g''
        | sed ''s/--*/-/g'' | cut -c1-50 | sed ''s/-$//'')")


        # Generate PR title

        PR_TITLE="Fix: $ISSUE_TITLE"


        echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

        echo "pr_title=$PR_TITLE" >> $GITHUB_OUTPUT


        echo "## Generated Details" >> $GITHUB_STEP_SUMMARY

        echo "" >> $GITHUB_STEP_SUMMARY

        echo "- **Branch**: \`$BRANCH_NAME\`" >> $GITHUB_STEP_SUMMARY

        echo "- **PR Title**: $PR_TITLE" >> $GITHUB_STEP_SUMMARY

        '
    - name: Analyze issue and create task file
      id: analyze_issue
      if: steps.get_issue.outputs.is_auto_generated != 'true' && steps.check_existing.outputs.should_skip != 'true'
      run: "ISSUE_NUMBER=\"${{ steps.get_issue.outputs.issue_number }}\"\nISSUE_TITLE=\"${{ steps.get_issue.outputs.issue_title\
        \ }}\"\n\n# Create analysis of the issue\npython3 << 'PYTHON_EOF'\nimport json\nimport re\n\n# Read issue body\nwith\
        \ open('/tmp/issue_body.txt', 'r') as f:\n    issue_body = f.read()\n\n# Extract key information\nanalysis = {\n \
        \   'issue_number': '${{ steps.get_issue.outputs.issue_number }}',\n    'issue_title': '${{ steps.get_issue.outputs.issue_title\
        \ }}',\n    'categories': [],\n    'keywords': [],\n    'complexity': 'medium',\n    'estimated_effort': 'moderate'\n\
        }\n\n# Categorize based on keywords\nkeywords_map = {\n    'bug': ['bug', 'error', 'broken', 'fail', 'crash', 'exception'],\n\
        \    'feature': ['feature', 'add', 'implement', 'support', 'new'],\n    'documentation': ['doc', 'readme', 'guide',\
        \ 'tutorial', 'documentation'],\n    'test': ['test', 'testing', 'coverage', 'spec'],\n    'ci/cd': ['workflow', 'ci',\
        \ 'cd', 'pipeline', 'action'],\n    'dependency': ['dependency', 'package', 'version', 'upgrade'],\n    'performance':\
        \ ['performance', 'slow', 'optimization', 'speed']\n}\n\nissue_text = (issue_body + ' ' + '${{ steps.get_issue.outputs.issue_title\
        \ }}').lower()\n\nfor category, keywords in keywords_map.items():\n    if any(kw in issue_text for kw in keywords):\n\
        \        analysis['categories'].append(category)\n        analysis['keywords'].extend([kw for kw in keywords if kw\
        \ in issue_text])\n\n# Default category if none detected\nif not analysis['categories']:\n    analysis['categories']\
        \ = ['general']\n\n# Save analysis\nwith open('/tmp/issue_analysis.json', 'w') as f:\n    json.dump(analysis, f, indent=2)\n\
        \nprint(f\"Analysis complete: {analysis['categories']}\")\nPYTHON_EOF\n\necho \"analysis_complete=true\" >> $GITHUB_OUTPUT\n\
        \n# Show analysis\necho \"\" >> $GITHUB_STEP_SUMMARY\necho \"## Issue Analysis\" >> $GITHUB_STEP_SUMMARY\npython3\
        \ -c \"\nimport json\nwith open('/tmp/issue_analysis.json') as f:\n    data = json.load(f)\n    print('- **Categories**:\
        \ ' + ', '.join(data['categories']))\n    print('- **Complexity**: ' + data['complexity'])\n    print('- **Estimated\
        \ Effort**: ' + data['estimated_effort'])\n\" >> $GITHUB_STEP_SUMMARY\n"
    - name: Create draft PR branch and commit
      id: create_branch
      if: steps.get_issue.outputs.is_auto_generated != 'true' && steps.check_existing.outputs.should_skip != 'true'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: "ISSUE_NUMBER=\"${{ steps.get_issue.outputs.issue_number }}\"\nBRANCH_NAME=\"${{ steps.generate_details.outputs.branch_name\
        \ }}\"\n\n# Configure git\ngit config user.name \"github-actions[bot]\"\ngit config user.email \"41898282+github-actions[bot]@users.noreply.github.com\"\
        \n\n# Get default branch\nDEFAULT_BRANCH=$(git rev-parse --abbrev-ref HEAD)\necho \"Default branch: $DEFAULT_BRANCH\"\
        \n\n# Create and checkout new branch\ngit checkout -b \"$BRANCH_NAME\"\n\n# Create README for the PR\ncat > ISSUE_${ISSUE_NUMBER}_README.md\
        \ << 'README_EOF'\n# Automated Issue Resolution\n\nThis branch was created automatically to address issue #${{ steps.get_issue.outputs.issue_number\
        \ }}.\n\n## Issue Details\n\n**Title**: ${{ steps.get_issue.outputs.issue_title }}\n**Author**: @${{ steps.get_issue.outputs.issue_author\
        \ }}\n**Link**: https://github.com/${{ github.repository }}/issues/${{ steps.get_issue.outputs.issue_number }}\n\n\
        ## Description\n\nREADME_EOF\n\n# Add issue body\ncat /tmp/issue_body.txt >> ISSUE_${ISSUE_NUMBER}_README.md\n\ncat\
        \ >> ISSUE_${ISSUE_NUMBER}_README.md << 'README_EOF'\n\n## Next Steps\n\nGitHub Copilot will automatically analyze\
        \ this issue and implement the necessary changes.\n\n@copilot will be mentioned in the PR to trigger the automated\
        \ implementation.\n\n---\n\n\U0001F916 *This file was auto-generated by the Issue-to-Draft-PR workflow*\nREADME_EOF\n\
        \ngit add ISSUE_${ISSUE_NUMBER}_README.md\ngit commit -m \"chore: Initialize branch for issue #$ISSUE_NUMBER\n\nThis\
        \ commit creates a branch for automated resolution of:\n${{ steps.get_issue.outputs.issue_title }}\n\nRelated Issue:\
        \ #$ISSUE_NUMBER\nAuthor: @${{ steps.get_issue.outputs.issue_author }}\"\n\ngit push origin \"$BRANCH_NAME\"\n\necho\
        \ \"branch_created=true\" >> $GITHUB_OUTPUT\necho \"default_branch=$DEFAULT_BRANCH\" >> $GITHUB_OUTPUT\n"
    - name: Create draft PR with Copilot mention
      id: create_pr
      if: steps.create_branch.outputs.branch_created == 'true'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        ISSUE_AUTHOR: ${{ steps.get_issue.outputs.issue_author }}
        ISSUE_NUMBER_ENV: ${{ steps.get_issue.outputs.issue_number }}
        ISSUE_TITLE_ENV: ${{ steps.get_issue.outputs.issue_title }}
        BRANCH_NAME_ENV: ${{ steps.generate_details.outputs.branch_name }}
        PR_TITLE_ENV: ${{ steps.generate_details.outputs.pr_title }}
        DEFAULT_BRANCH_ENV: ${{ steps.create_branch.outputs.default_branch }}
        REPO_FULL: ${{ github.repository }}
        RUN_ID: ${{ github.run_id }}
      run: |
        ISSUE_NUMBER="$ISSUE_NUMBER_ENV"
        BRANCH_NAME="$BRANCH_NAME_ENV"
        PR_TITLE="$PR_TITLE_ENV"
        DEFAULT_BRANCH="$DEFAULT_BRANCH_ENV"
        
        # Create PR body
        ISSUE_TITLE="$ISSUE_TITLE_ENV"
        # ISSUE_AUTHOR is available as $ISSUE_AUTHOR via env (see above)
        cat > /tmp/pr_body.md <<'PR_EOF'
        ## ü§ñ Automated Issue Resolution
        
        This PR addresses issue #${ISSUE_NUMBER}.
        
        ### Related Issue
        
        Fixes #${ISSUE_NUMBER}
        ### Issue Summary
        
        **Title**: ${ISSUE_TITLE}
        **Author**: @${ISSUE_AUTHOR}
        
        ### Original Issue Description
        
        PR_EOF
        
        # Add issue body
        cat /tmp/issue_body.txt >> /tmp/pr_body.md
        
        cat >> /tmp/pr_body.md << 'PR_EOF'
        
        ### Analysis
        
        PR_EOF
        
        # Add analysis
        python3 -c "
        import json
        with open('/tmp/issue_analysis.json') as f:
            data = json.load(f)
            print('- **Categories**: ' + ', '.join(data['categories']))
            print('- **Complexity**: ' + data['complexity'])
            print('- **Keywords**: ' + ', '.join(data.get('keywords', [])[:5]))
        " >> /tmp/pr_body.md
        
        cat >> /tmp/pr_body.md <<PR_EOF
        
        ### What This PR Does
        
        This is a draft PR that will be automatically updated by GitHub Copilot to resolve the issue.
        
        GitHub Copilot will be invoked automatically using the Copilot CLI tool to implement the necessary changes.
        
        Focus on:
        - Understanding the problem described in the issue
        - Implementing a minimal, surgical fix
        - Adding or updating tests as appropriate
        - Following the existing code style and patterns
        - Documenting any significant changes
        
        ### Task Checklist
        
        - [ ] Analyze the issue requirements
        - [ ] Implement the solution
        - [ ] Add/update tests
        - [ ] Update documentation if needed
        - [ ] Verify the fix works as expected
        
        ---
        
        ü§ñ **Auto-generated by**: Issue-to-Draft-PR Workflow
        **Issue**: #${ISSUE_NUMBER}
        **Workflow Run**: [${RUN_ID}](https://github.com/${REPO_FULL}/actions/runs/${RUN_ID})
        PR_EOF
        
        # Create draft PR
        set +e  # Don't exit on error
        PR_URL=$(gh pr create \
          --draft \
          --title "$PR_TITLE" \
          --body-file /tmp/pr_body.md \
          --base "$DEFAULT_BRANCH" \
          --head "$BRANCH_NAME" 2>&1)
        PR_CREATE_EXIT=$?
        set -e  # Re-enable exit on error
        
        if [ $PR_CREATE_EXIT -eq 0 ]; then
          PR_NUMBER=$(echo "$PR_URL" | grep -oP '\d+$')
          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "‚úÖ Successfully created PR #$PR_NUMBER"
          
          # Invoke Copilot using the verified dual method (draft PR + @copilot trigger)
          # This is the ONLY method with 100% success rate
          echo "Invoking GitHub Copilot on PR #$PR_NUMBER using verified dual method..."
          
          # Always use the JSON context file which safely contains issue details
          # The issue analysis JSON is created earlier and contains sanitized data
          if [ -f "/tmp/issue_analysis.json" ]; then
            # Read issue details from JSON and export as environment variables to avoid injection
            export COPILOT_ISSUE_TITLE=$(jq -r '.issue_title // "Implement solution"' /tmp/issue_analysis.json)
            export COPILOT_ISSUE_BODY=$(jq -r '.body // "See issue for details"' /tmp/issue_analysis.json | head -c 500)
            
            # Use environment variables in Python call to prevent injection
            python3 scripts/invoke_copilot_on_pr.py \
              --pr "$PR_NUMBER" \
              --instruction "Please implement a solution for issue #${ISSUE_NUMBER}. Review the full issue description in the PR and implement minimal, surgical changes." \
              || echo "‚ö†Ô∏è  Copilot invocation failed, check logs"
          else
            # Fallback to basic instruction without user-controlled content
            python3 scripts/invoke_copilot_on_pr.py \
              --pr "$PR_NUMBER" \
              --instruction "Please implement a solution for this issue. Review the full issue description in the PR and implement minimal, surgical changes." \
              || echo "‚ö†Ô∏è  Copilot invocation failed, check logs"
          fi
          
          # Link PR back to issue
          gh issue comment "$ISSUE_NUMBER" --repo ${REPO_FULL} --body "ü§ñ **Automatic Draft PR Created**
        
        A draft PR has been created to address this issue: #$PR_NUMBER
        
        GitHub Copilot has been assigned and will implement the solution automatically.
        
        **PR**: $PR_URL
        **Branch**: \`$BRANCH_NAME\`
        
        You can monitor the progress in the draft PR. The PR will be ready for review once Copilot completes the implementation."
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ‚úÖ Draft PR Created Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üîó **Issue**: #$ISSUE_NUMBER" >> $GITHUB_STEP_SUMMARY
          echo "üîó **PR**: $PR_URL" >> $GITHUB_STEP_SUMMARY
          echo "üî¢ **PR Number**: #$PR_NUMBER" >> $GITHUB_STEP_SUMMARY
          echo "üåø **Branch**: \`$BRANCH_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "ü§ñ **Status**: GitHub Copilot invoked via verified dual method (draft PR + @copilot trigger)" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ö†Ô∏è Could not create PR automatically (permission denied or other error)"
          echo "Error: $PR_URL"
          echo "pr_url=" >> $GITHUB_OUTPUT
          echo "pr_number=" >> $GITHUB_OUTPUT
          
          # Update issue with manual PR creation instructions
          gh issue comment "$ISSUE_NUMBER" --repo ${REPO_FULL} --body "‚ö†Ô∏è **Automatic PR creation failed**
        
        The branch has been created: \`$BRANCH_NAME\`
        
        **To create the PR manually**:
        1. Go to: https://github.com/${REPO_FULL}/compare/${DEFAULT_BRANCH}...$BRANCH_NAME
        2. Click 'Create pull request'
        3. Mark it as a draft
        4. Use the invoke_copilot_on_pr.py script to invoke GitHub Copilot:
           \`\`\`bash
           python3 scripts/invoke_copilot_on_pr.py --pr <PR_NUMBER>
           \`\`\`
        
        **Or enable automatic PR creation**:
        1. Go to Settings ‚Üí Actions ‚Üí General ‚Üí Workflow permissions
        2. Select 'Read and write permissions'
        3. Check 'Allow GitHub Actions to create and approve pull requests'"
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ‚ö†Ô∏è PR Creation Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üîó **Issue**: #$ISSUE_NUMBER" >> $GITHUB_STEP_SUMMARY
          echo "üåø **Branch**: \`$BRANCH_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "‚ö†Ô∏è **Note**: See issue for manual PR creation steps" >> $GITHUB_STEP_SUMMARY
        fi
    - name: Summary
      if: always()
      env:
        SKIP_REASON: ${{ steps.check_existing.outputs.skip_reason }}
        ISSUE_NUMBER: ${{ steps.get_issue.outputs.issue_number }}
        BRANCH_CREATED: ${{ steps.create_branch.outputs.branch_created }}
        PR_CREATED: ${{ steps.create_pr.outputs.pr_number }}
        BRANCH_NAME: ${{ steps.generate_details.outputs.branch_name }}
      run: "echo \"\" >> $GITHUB_STEP_SUMMARY\necho \"---\" >> $GITHUB_STEP_SUMMARY\necho \"\" >> $GITHUB_STEP_SUMMARY\n\n\
        if [ \"${{ steps.check_existing.outputs.should_skip }}\" = \"true\" ]; then\n  echo \"### \u23ED\uFE0F Skipped\" >>\
        \ $GITHUB_STEP_SUMMARY\n  echo \"- \U0001F50D Reason: $SKIP_REASON\" >> $GITHUB_STEP_SUMMARY\nelse\n  echo \"### \U0001F916\
        \ Issue-to-PR Conversion Status\" >> $GITHUB_STEP_SUMMARY\n  echo \"- \U0001F4DD Issue: #$ISSUE_NUMBER\" >> $GITHUB_STEP_SUMMARY\n\
        \  echo \"- \U0001F33F Branch Created: $BRANCH_CREATED\" >> $GITHUB_STEP_SUMMARY\n  if [ -n \"$PR_CREATED\" ]; then\n\
        \    echo \"- \U0001F4CB PR Created: true\" >> $GITHUB_STEP_SUMMARY\n  else\n    echo \"- \U0001F4CB PR Created: false\"\
        \ >> $GITHUB_STEP_SUMMARY\n  fi\n  \n  if [ -n \"$PR_CREATED\" ]; then\n    echo \"\" >> $GITHUB_STEP_SUMMARY\n  \
        \  echo \"#### \u2705 Success!\" >> $GITHUB_STEP_SUMMARY\n    echo \"- **Issue**: #$ISSUE_NUMBER\" >> $GITHUB_STEP_SUMMARY\n\
        \    echo \"- **Draft PR**: #$PR_CREATED\" >> $GITHUB_STEP_SUMMARY\n    echo \"- **Branch**: \\`$BRANCH_NAME\\`\"\
        \ >> $GITHUB_STEP_SUMMARY\n    echo \"- **Status**: GitHub Copilot assigned via @mention\" >> $GITHUB_STEP_SUMMARY\n\
        \    echo \"\" >> $GITHUB_STEP_SUMMARY\n    echo \"**Next**: Monitor PR #$PR_CREATED for Copilot's implementation\"\
        \ >> $GITHUB_STEP_SUMMARY\n  fi\nfi\n"
    - name: Upload artifacts
      if: always() && steps.analyze_issue.outputs.analysis_complete == 'true'
      uses: actions/upload-artifact@v4
        with:
        name: issue-to-pr-${{ steps.get_issue.outputs.issue_number }}
        path: '/tmp/issue_body.txt

          /tmp/issue_analysis.json

          /tmp/pr_body.md

          '
        retention-days: 30
