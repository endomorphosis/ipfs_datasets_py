name: ARM64 Self-Hosted Runner
true:
  workflow_dispatch:
    inputs:
      test_suite:
        description: Test suite to run
        required: true
        default: comprehensive
        type: choice
        options:
        - comprehensive
        - mcp-dashboard
        - docker-build
        - integration
  push:
    branches:
    - main
    - develop
    paths:
    - ipfs_datasets_py/**
    - tests/**
    - .github/workflows/arm64-runner.yml
    - docker/Dockerfile*
  pull_request:
    branches:
    - main
    - develop
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
permissions:
  contents: read
  actions: read
env:
  PYTHON_VERSION: '3.12'
jobs:
  arm64-system-info:
    runs-on:
    - self-hosted
    - linux
    - arm64
    timeout-minutes: 45
    if: ${{ !cancelled() }}
    steps:
    - name: System Information
      run: "echo \"## \U0001F9BE ARM64 Runner Information\" >> $GITHUB_STEP_SUMMARY\necho \"\" >> $GITHUB_STEP_SUMMARY\necho\
        \ \"### Hardware\" >> $GITHUB_STEP_SUMMARY\necho \"- **Architecture**: $(uname -m)\" >> $GITHUB_STEP_SUMMARY\necho\
        \ \"- **OS**: $(cat /etc/os-release | grep PRETTY_NAME | cut -d= -f2 | tr -d '\\\"')\" >> $GITHUB_STEP_SUMMARY\necho\
        \ \"- **Kernel**: $(uname -r)\" >> $GITHUB_STEP_SUMMARY\necho \"- **CPU**: $(lscpu | grep 'Model name' | cut -d: -f2\
        \ | xargs)\" >> $GITHUB_STEP_SUMMARY\necho \"- **CPU Cores**: $(nproc)\" >> $GITHUB_STEP_SUMMARY\necho \"- **Memory**:\
        \ $(free -h | grep Mem | awk '{print $2}')\" >> $GITHUB_STEP_SUMMARY\necho \"- **Disk**: $(df -h / | tail -1 | awk\
        \ '{print $4}') available\" >> $GITHUB_STEP_SUMMARY\necho \"\" >> $GITHUB_STEP_SUMMARY\necho \"### Software\" >> $GITHUB_STEP_SUMMARY\n\
        echo \"- **Python**: $(python3 --version)\" >> $GITHUB_STEP_SUMMARY\necho \"- **Docker**: $(docker --version 2>/dev/null\
        \ || echo 'Not installed')\" >> $GITHUB_STEP_SUMMARY\necho \"- **Git**: $(git --version)\" >> $GITHUB_STEP_SUMMARY\n\
        echo \"\" >> $GITHUB_STEP_SUMMARY\n"
    - name: Check Performance
      run: "echo \"### Performance Metrics\" >> $GITHUB_STEP_SUMMARY\necho \"\\`\\`\\`\" >> $GITHUB_STEP_SUMMARY\necho \"\
        CPU Benchmark (calculating \u03C0 to 1000 places):\" >> $GITHUB_STEP_SUMMARY\ntime python3 -c \"\nfrom decimal import\
        \ Decimal, getcontext\nimport time\ngetcontext().prec = 1000\nstart = time.time()\npi = sum(1/Decimal(16)**k * (Decimal(4)/(8*k+1)\
        \ - Decimal(2)/(8*k+4) - Decimal(1)/(8*k+5) - Decimal(1)/(8*k+6)) for k in range(500))\nend = time.time()\nprint(f'Completed\
        \ in {end-start:.3f} seconds')\n\" >> $GITHUB_STEP_SUMMARY 2>&1\necho \"\\`\\`\\`\" >> $GITHUB_STEP_SUMMARY\n"
  arm64-mcp-dashboard:
    runs-on:
    - self-hosted
    - linux
    - arm64
    timeout-minutes: 45
    needs: arm64-system-info
    if: ${{ !cancelled() && (github.event.inputs.test_suite == 'comprehensive' || github.event.inputs.test_suite == 'mcp-dashboard'
      || github.event_name != 'workflow_dispatch') }}
    steps:
    - name: Clean up submodules before checkout
      run: "cd $GITHUB_WORKSPACE || exit 0\nif [ -d \".git\" ]; then\n  echo \"Deinitializing all submodules to prevent recursive\
        \ cleanup errors...\"\n  git submodule deinit --all -f || true\n  rm -rf .git/modules || true\nfi\n"
      continue-on-error: true
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 1
        submodules: false
    - name: Set up Python
      run: '# Ensure we have Python 3.12 on ARM64

        python3 --version

        python3 -m pip install --upgrade pip

        '
    - name: Create virtual environment
      run: 'python3 -m venv .venv-arm64

        source .venv-arm64/bin/activate

        pip install --upgrade pip setuptools wheel

        '
    - name: Install dependencies
      run: 'source .venv-arm64/bin/activate

        # Install without ''all'' extra to avoid ipld-car issues

        pip install -e .[test]

        pip install flask mcp pytest pytest-cov

        '
    - name: Validate MCP Dashboard
      run: "source .venv-arm64/bin/activate\necho \"\U0001F9EA Running MCP Dashboard validation on ARM64...\"\npython validate_mcp_dashboard.py\n\
        echo \"\u2705 MCP Dashboard validation completed\" >> $GITHUB_STEP_SUMMARY\n"
    - name: Test MCP Tools
      run: "source .venv-arm64/bin/activate\necho \"\U0001F527 Testing MCP tools availability...\"\npython -c \"\ntry:\n \
        \   from ipfs_datasets_py.mcp_server.tools import get_all_tools\n    tools = get_all_tools()\n    print(f'\u2705 Found\
        \ {len(tools)} MCP tools')\n    print('Sample tools:')\n    for i, (name, desc) in enumerate(list(tools.items())[:5]):\n\
        \        print(f'  {i+1}. {name}: {desc}')\nexcept Exception as e:\n    print(f'\u26A0\uFE0F Error loading MCP tools:\
        \ {e}')\n\"\n"
    - name: ARM64 Performance Test
      run: "source .venv-arm64/bin/activate\necho \"\u26A1 Running ARM64-specific performance tests...\"\npython -c \"\nimport\
        \ time\nimport numpy as np\n\n# Test numpy performance on ARM64\nprint('Testing NumPy performance...')\nstart = time.time()\n\
        a = np.random.rand(1000, 1000)\nb = np.random.rand(1000, 1000)\nc = np.dot(a, b)\nend = time.time()\nprint(f'Matrix\
        \ multiplication (1000x1000): {end-start:.3f}s')\n\n# Test dataset loading\nprint('Testing dataset operations...')\n\
        from ipfs_datasets_py import IPFSDatasets\nimport inspect\nif IPFSDatasets is not None and inspect.isclass(IPFSDatasets):\n\
        \    print('\u2705 IPFSDatasets class is available')\nelse:\n    print('\u26A0\uFE0F IPFSDatasets class not available\
        \ (missing dependencies)')\n\"\n"
  arm64-docker-build:
    runs-on:
    - self-hosted
    - linux
    - arm64
    timeout-minutes: 90
    needs: arm64-system-info
    if: ${{ !cancelled() && (github.event.inputs.test_suite == 'comprehensive' || github.event.inputs.test_suite == 'docker-build'
      || github.event_name != 'workflow_dispatch') }}
    steps:
    - name: Clean up submodules before checkout
      run: "cd $GITHUB_WORKSPACE || exit 0\nif [ -d \".git\" ]; then\n  echo \"Deinitializing all submodules to prevent recursive\
        \ cleanup errors...\"\n  git submodule deinit --all -f || true\n  rm -rf .git/modules || true\nfi\n"
      continue-on-error: true
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 1
        submodules: false
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    - name: Build ARM64 Docker Image
      run: "echo \"\U0001F528 Building Docker image for ARM64...\"\ndocker buildx build \\\n  --platform linux/arm64 \\\n\
        \  --tag ipfs-datasets-py:arm64-test \\\n  --file docker/Dockerfile.test \\\n  --load \\\n  .\necho \"\u2705 ARM64\
        \ Docker image built successfully\" >> $GITHUB_STEP_SUMMARY\n"
    - name: Test ARM64 Docker Container
      run: "echo \"\U0001F9EA Testing ARM64 Docker container...\"\ndocker run --rm --platform linux/arm64 ipfs-datasets-py:arm64-test\
        \ python -c \"\nimport sys, platform, os\nprint(f'Python: {sys.version}')\nprint(f'Platform: {platform.platform()}')\n\
        print(f'Machine: {platform.machine()}')\nprint(f'Processor: {platform.processor()}')\n\n# Test package import\ntry:\n\
        \    import ipfs_datasets_py\n    import inspect\n    print('\u2705 Package imported successfully')\n    \n    # Test\
        \ IPFSDatasets class is available\n    from ipfs_datasets_py import IPFSDatasets\n    print(f'\u2705 IPFSDatasets\
        \ class available: {IPFSDatasets}')\n    \n    # Verify it's a class (not None when dependencies are available)\n\
        \    if IPFSDatasets is not None and inspect.isclass(IPFSDatasets):\n        print('\u2705 IPFSDatasets class loaded\
        \ successfully')\n    else:\n        print('\u26A0\uFE0F IPFSDatasets is None (dependencies may be missing, but import\
        \ succeeded)')\n    \nexcept Exception as e:\n    print(f'\u274C Error: {e}')\n    sys.exit(1)\n\"\necho \"\u2705\
        \ ARM64 Docker container test passed\" >> $GITHUB_STEP_SUMMARY\n"
    - name: Build MCP Dashboard Docker (ARM64)
      run: "echo \"\U0001F39B\uFE0F Building MCP Dashboard Docker image for ARM64...\"\ndocker buildx build \\\n  --platform\
        \ linux/arm64 \\\n  --tag ipfs-datasets-mcp-dashboard:arm64 \\\n  --file docker/Dockerfile.dashboard-minimal \\\n\
        \  --load \\\n  .\n"
    - name: Test MCP Dashboard Container
      run: "echo \"\U0001F9EA Testing MCP Dashboard container...\"\n# Start container in background\ndocker run -d --rm --name\
        \ mcp-dashboard-arm64-test \\\n  --platform linux/arm64 \\\n  -p 8900:8899 \\\n  -e MCP_DASHBOARD_HOST=0.0.0.0 \\\n\
        \  -e MCP_DASHBOARD_PORT=8899 \\\n  ipfs-datasets-mcp-dashboard:arm64\n\n# Wait for startup\nsleep 10\n\n# Test endpoint\n\
        if curl -f http://localhost:8900/api/mcp/status; then\n  echo \"\u2705 MCP Dashboard container working on ARM64\"\
        \ >> $GITHUB_STEP_SUMMARY\nelse\n  echo \"\u274C MCP Dashboard container failed\" >> $GITHUB_STEP_SUMMARY\nfi\n\n\
        # Stop container\ndocker stop mcp-dashboard-arm64-test || true\n"
    - name: Cleanup ARM64 Images
      if: always()
      run: 'docker rmi ipfs-datasets-py:arm64-test || true

        docker rmi ipfs-datasets-mcp-dashboard:arm64 || true

        docker system prune -f || true

        '
  arm64-integration-tests:
    runs-on:
    - self-hosted
    - linux
    - arm64
    timeout-minutes: 45
    needs:
    - arm64-mcp-dashboard
    - arm64-docker-build
    if: ${{ !cancelled() && (github.event.inputs.test_suite == 'comprehensive' || github.event.inputs.test_suite == 'integration'
      || github.event_name != 'workflow_dispatch') }}
    steps:
    - name: Clean up submodules before checkout
      run: "cd $GITHUB_WORKSPACE || exit 0\nif [ -d \".git\" ]; then\n  echo \"Deinitializing all submodules to prevent recursive\
        \ cleanup errors...\"\n  git submodule deinit --all -f || true\n  rm -rf .git/modules || true\nfi\n"
      continue-on-error: true
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 1
        submodules: false
    - name: Set up test environment
      run: 'python3 -m venv .venv-integration

        source .venv-integration/bin/activate

        # Install without ''all'' extra to avoid ipld-car issues on ARM64

        pip install -e .[test]

        '
    - name: Run Integration Tests
      run: "source .venv-integration/bin/activate\necho \"\U0001F517 Running ARM64 integration tests...\"\n\n# Create comprehensive\
        \ test suite\npython -c \"\nimport pytest\nimport sys\nimport os\n\n# Run tests with ARM64-specific markers\nexit_code\
        \ = pytest.main([\n    'tests/',\n    '-v',\n    '-m', 'not gpu',  # Skip GPU tests on ARM64 for now\n    '--tb=short',\n\
        \    '--junit-xml=arm64-integration-results.xml'\n])\n\nsys.exit(exit_code)\n\" || echo \"Some integration tests failed\
        \ on ARM64\"\n"
    - name: Upload ARM64 Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: arm64-integration-results
        path: 'arm64-integration-results.xml

          test_outputs/

          '
  architecture-comparison:
    runs-on:
    - self-hosted
    - linux
    - x64
    timeout-minutes: 45
    container:
      image: python:3.12-slim
      options: --user root
    needs:
    - arm64-system-info
    - arm64-mcp-dashboard
    - arm64-docker-build
    - arm64-integration-tests
    if: always()
    steps:
    - name: Generate Architecture Summary
      run: "echo \"## \U0001F3D7\uFE0F Multi-Architecture Test Results\" >> $GITHUB_STEP_SUMMARY\necho \"\" >> $GITHUB_STEP_SUMMARY\n\
        echo \"| Architecture | System Info | MCP Dashboard | Docker Build | Integration Tests |\" >> $GITHUB_STEP_SUMMARY\n\
        echo \"|--------------|-------------|---------------|--------------|-------------------|\" >> $GITHUB_STEP_SUMMARY\n\
        echo \"| ARM64 | ${{ needs.arm64-system-info.result }} | ${{ needs.arm64-mcp-dashboard.result }} | ${{ needs.arm64-docker-build.result\
        \ }} | ${{ needs.arm64-integration-tests.result }} |\" >> $GITHUB_STEP_SUMMARY\necho \"\" >> $GITHUB_STEP_SUMMARY\n\
        \n# Recommendations based on results\necho \"### Recommendations\" >> $GITHUB_STEP_SUMMARY\necho \"\" >> $GITHUB_STEP_SUMMARY\n\
        \nif [ \"${{ needs.arm64-system-info.result }}\" = \"success\" ]; then\n  echo \"\u2705 ARM64 self-hosted runner is\
        \ properly configured\" >> $GITHUB_STEP_SUMMARY\nelse\n  echo \"\u26A0\uFE0F ARM64 runner setup needs attention\"\
        \ >> $GITHUB_STEP_SUMMARY\n  echo \"- Check runner labels: \\`self-hosted\\`, \\`linux\\`, \\`arm64\\`\" >> $GITHUB_STEP_SUMMARY\n\
        \  echo \"- Verify Python 3.12 installation\" >> $GITHUB_STEP_SUMMARY\n  echo \"- Ensure Docker is installed and running\"\
        \ >> $GITHUB_STEP_SUMMARY\nfi\n\nif [ \"${{ needs.arm64-mcp-dashboard.result }}\" = \"success\" ]; then\n  echo \"\
        \u2705 MCP Dashboard works correctly on ARM64\" >> $GITHUB_STEP_SUMMARY\nelse\n  echo \"\u26A0\uFE0F MCP Dashboard\
        \ may have ARM64-specific issues\" >> $GITHUB_STEP_SUMMARY\nfi\n\nif [ \"${{ needs.arm64-docker-build.result }}\"\
        \ = \"success\" ]; then\n  echo \"\u2705 Docker builds work on ARM64 architecture\" >> $GITHUB_STEP_SUMMARY\nelse\n\
        \  echo \"\u26A0\uFE0F Docker builds may need ARM64-specific optimization\" >> $GITHUB_STEP_SUMMARY\nfi\n\necho \"\
        \" >> $GITHUB_STEP_SUMMARY\necho \"For complete multi-architecture support, ensure both x86_64 and ARM64 runners are\
        \ available.\" >> $GITHUB_STEP_SUMMARY\n"
