name: Documentation Maintenance
true:
  schedule:
  - cron: 0 9 * * 1
  workflow_dispatch:
    inputs:
      full_scan:
        description: Perform full documentation scan
        required: false
        default: 'true'
        type: boolean
      auto_fix:
        description: Automatically fix simple issues
        required: false
        default: 'true'
        type: boolean
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
permissions:
  contents: write
  pull-requests: write
  issues: write
env:
  PYTHON_VERSION: '3.12'
jobs:
  documentation-audit:
    runs-on:
    - self-hosted
    - linux
    - x64
    timeout-minutes: 45
    container:
      image: python:3.12-slim
      options: --user root
    name: Maintain Documentation Health
    steps:
    - name: Install system dependencies
      run: 'apt-get update

        apt-get install -y git curl

        '
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 0
    - name: Install Python dependencies
      run: 'python --version

        python -m pip install --upgrade pip

        pip install PyYAML pathlib

        '
    - name: Run documentation finder
      id: find_docs
      run: "echo \"\U0001F50D Finding documentation files...\"\npython scripts/dev_tools/find_documentation.py \\\n  --directory\
        \ . \\\n  --format json \\\n  --output /tmp/documentation_report.json \\\n  --verbose\n\nif [ -f /tmp/documentation_report.json\
        \ ]; then\n  echo \"\u2705 Documentation report generated\"\n  cat /tmp/documentation_report.json\nelse\n  echo \"\
        \u274C Failed to generate documentation report\"\n  exit 1\nfi\n"
    - name: Run docstring audit
      id: docstring_audit
      run: "echo \"\U0001F4DD Auditing docstrings...\"\npython scripts/dev_tools/docstring_audit.py \\\n  --directory ipfs_datasets_py\
        \ \\\n  --output /tmp/docstring_report.json\n\nif [ -f /tmp/docstring_report.json ]; then\n  echo \"\u2705 Docstring\
        \ audit completed\"\nelse\n  echo \"\u26A0\uFE0F Docstring audit encountered issues\"\nfi\n"
      continue-on-error: true
    - name: Check for missing documentation files
      id: missing_docs
      run: "echo \"\U0001F50D Checking for missing documentation files...\"\n\n# Create report\ncat > /tmp/missing_docs_report.md\
        \ << 'EOF'\n# Missing Documentation Report\n\n## Directories Missing Documentation\n\nEOF\n\n# Find directories missing\
        \ README.md, TODO.md, or CHANGELOG.md\nfind ipfs_datasets_py -type d -not -path \"*/\\.*\" -not -path \"*/__pycache__*\"\
        \ | while IFS= read -r dir; do\n  missing=\"\"\n  if [ ! -f \"$dir/README.md\" ]; then\n    missing=\"${missing}README.md\
        \ \"\n  fi\n  if [ ! -f \"$dir/TODO.md\" ]; then\n    missing=\"${missing}TODO.md \"\n  fi\n  if [ ! -f \"$dir/CHANGELOG.md\"\
        \ ]; then\n    missing=\"${missing}CHANGELOG.md \"\n  fi\n  \n  if [ -n \"$missing\" ]; then\n    echo \"- \\`$dir\\\
        `: Missing $missing\" >> /tmp/missing_docs_report.md\n  fi\ndone\n\necho \"\" >> /tmp/missing_docs_report.md\necho\
        \ \"---\" >> /tmp/missing_docs_report.md\necho \"Generated: $(date -u +\"%Y-%m-%d %H:%M:%S UTC\")\" >> /tmp/missing_docs_report.md\n\
        \ncat /tmp/missing_docs_report.md\n"
    - name: Auto-fix missing documentation files
      id: auto_fix_docs
      if: github.event.inputs.auto_fix == 'true' || github.event_name == 'schedule'
      run: "echo \"\U0001F527 Creating missing documentation files...\"\n\n# Track if any changes were made\nchanges_made=false\n\
        \n# Find directories missing documentation files and create them\nfind ipfs_datasets_py -type d -not -path \"*/\\\
        .*\" -not -path \"*/__pycache__*\" -not -path \"*/node_modules/*\" | while IFS= read -r dir; do\n  dir_name=$(basename\
        \ \"$dir\")\n  parent_dir=$(dirname \"$dir\")\n  \n  # Skip if directory is empty or only contains __pycache__\n \
        \ if [ -z \"$(ls -A \"$dir\" 2>/dev/null | grep -v __pycache__)\" ]; then\n    continue\n  fi\n  \n  # Create README.md\
        \ if missing\n  if [ ! -f \"$dir/README.md\" ]; then\n    echo \"Creating README.md in $dir\"\n    cat > \"$dir/README.md\"\
        \ << EOFREADME\n# ${dir_name}\n\n## Overview\n\nThis directory contains ${dir_name} components for the ipfs_datasets_py\
        \ project.\n\n## Contents\n\n<!-- Add description of key files and modules here -->\n\n## Usage\n\n<!-- Add usage\
        \ examples here -->\n\n## Related Documentation\n\n- [Main README](../../README.md)\n- [Project Documentation](../../docs/)\n\
        \n---\n*This file was auto-generated by the documentation maintenance workflow. Please update with specific details.*\n\
        EOFREADME\n    changes_made=true\n  fi\n  \n  # Create TODO.md if missing\n  if [ ! -f \"$dir/TODO.md\" ]; then\n\
        \    echo \"Creating TODO.md in $dir\"\n    cat > \"$dir/TODO.md\" << EOFTODO\n# TODO - ${dir_name}\n\n## Pending\
        \ Tasks\n\n- [ ] Add comprehensive documentation\n- [ ] Add usage examples\n- [ ] Add tests for all functions\n- [\
        \ ] Update docstrings with complete descriptions\n\n## Completed\n\n- [x] Directory structure created\n\n---\n*Last\
        \ updated: $(date -u +\"%Y-%m-%d\")*\nEOFTODO\n    changes_made=true\n  fi\n  \n  # Create CHANGELOG.md if missing\n\
        \  if [ ! -f \"$dir/CHANGELOG.md\" ]; then\n    echo \"Creating CHANGELOG.md in $dir\"\n    cat > \"$dir/CHANGELOG.md\"\
        \ << EOFCHANGELOG\n# Changelog - ${dir_name}\n\nAll notable changes to this module will be documented in this file.\n\
        \n## [Unreleased]\n\n### Added\n- Initial structure created\n\n---\n*Last updated: $(date -u +\"%Y-%m-%d\")*\nEOFCHANGELOG\n\
        \    changes_made=true\n  fi\ndone\n\n# Configure git\ngit config user.name \"github-actions[bot]\"\ngit config user.email\
        \ \"41898282+github-actions[bot]@users.noreply.github.com\"\n\n# Check if there are any changes\nif git diff --quiet\
        \ && git diff --staged --quiet; then\n  echo \"No documentation files needed to be created\"\n  echo \"changes_made=false\"\
        \ >> $GITHUB_OUTPUT\nelse\n  echo \"Documentation files created successfully\"\n  echo \"changes_made=true\" >> $GITHUB_OUTPUT\n\
        fi\n"
    - name: Analyze documentation freshness
      id: doc_freshness
      run: "echo \"\U0001F4C5 Analyzing documentation freshness...\"\n\ncat > /tmp/stale_docs_report.md << 'EOF'\n# Stale\
        \ Documentation Report\n\n## Documentation Files Not Updated Recently\n\nFiles not modified in the last 90 days:\n\
        \nEOF\n\n# Find documentation files older than 90 days\nfind . -type f \\( -name \"README.md\" -o -name \"TODO.md\"\
        \ -o -name \"CHANGELOG.md\" \\) \\\n  -not -path \"./.git/*\" \\\n  -mtime +90 \\\n  -exec ls -lh {} \\; | while IFS=\
        \ read -r line; do\n  echo \"- $line\" >> /tmp/stale_docs_report.md\ndone\n\necho \"\" >> /tmp/stale_docs_report.md\n\
        echo \"---\" >> /tmp/stale_docs_report.md\necho \"Generated: $(date -u +\"%Y-%m-%d %H:%M:%S UTC\")\" >> /tmp/stale_docs_report.md\n\
        \ncat /tmp/stale_docs_report.md\n"
    - name: Check documentation consistency
      id: doc_consistency
      run: "echo \"\U0001F504 Checking documentation consistency...\"\n\ncat > /tmp/consistency_report.md << 'EOF'\n# Documentation\
        \ Consistency Report\n\n## Issues Found\n\nEOF\n\n# Check if main README mentions all subdirectories with their own\
        \ READMEs\necho \"### Main README Coverage\" >> /tmp/consistency_report.md\necho \"\" >> /tmp/consistency_report.md\n\
        \nfind ipfs_datasets_py -maxdepth 2 -type f -name \"README.md\" | while IFS= read -r readme; do\n  dir=$(dirname \"\
        $readme\")\n  basename=$(basename \"$dir\")\n  if ! grep -q \"$basename\" README.md 2>/dev/null; then\n    echo \"\
        - Main README does not mention \\`$dir\\`\" >> /tmp/consistency_report.md\n  fi\ndone\n\necho \"\" >> /tmp/consistency_report.md\n\
        echo \"---\" >> /tmp/consistency_report.md\necho \"Generated: $(date -u +\"%Y-%m-%d %H:%M:%S UTC\")\" >> /tmp/consistency_report.md\n\
        \ncat /tmp/consistency_report.md\n"
    - name: Generate comprehensive report
      id: generate_report
      run: "echo \"\U0001F4CA Generating comprehensive documentation report...\"\n\n# Generate report header with proper date\
        \ substitution\n{\n  echo \"# Documentation Health Report\"\n  echo \"\"\n  echo \"**Generated:** $(date -u +\"%Y-%m-%d\
        \ %H:%M:%S UTC\")\"\n  echo \"**Repository:** ${{ github.repository }}\"\n  echo \"**Branch:** ${{ github.ref_name\
        \ }}\"\n  echo \"\"\n  echo \"## Summary\"\n  echo \"\"\n  echo \"This automated report analyzes the health and completeness\
        \ of documentation\"\n  echo \"across the repository for both human users and AI programming agents.\"\n  echo \"\"\
        \n  echo \"---\"\n  echo \"\"\n} > /tmp/documentation_health_report.md\n\n# Append all reports\nif [ -f /tmp/missing_docs_report.md\
        \ ]; then\n  cat /tmp/missing_docs_report.md >> /tmp/documentation_health_report.md\n  echo \"\" >> /tmp/documentation_health_report.md\n\
        fi\n\nif [ -f /tmp/stale_docs_report.md ]; then\n  cat /tmp/stale_docs_report.md >> /tmp/documentation_health_report.md\n\
        \  echo \"\" >> /tmp/documentation_health_report.md\nfi\n\nif [ -f /tmp/consistency_report.md ]; then\n  cat /tmp/consistency_report.md\
        \ >> /tmp/documentation_health_report.md\n  echo \"\" >> /tmp/documentation_health_report.md\nfi\n\n# Add docstring\
        \ quality section\nif [ -f /tmp/docstring_report.json ]; then\n  echo \"## Docstring Quality Analysis\" >> /tmp/documentation_health_report.md\n\
        \  echo \"\" >> /tmp/documentation_health_report.md\n  echo \"See attached docstring_report.json for detailed analysis.\"\
        \ >> /tmp/documentation_health_report.md\n  echo \"\" >> /tmp/documentation_health_report.md\nfi\n\necho \"## Recommendations\"\
        \ >> /tmp/documentation_health_report.md\necho \"\" >> /tmp/documentation_health_report.md\necho \"1. **Missing Documentation**:\
        \ \u2705 Auto-generated template files created (check PR if auto-fix was enabled)\" >> /tmp/documentation_health_report.md\n\
        echo \"2. **Stale Documentation**: Review and update documentation files that haven't been modified recently\" >>\
        \ /tmp/documentation_health_report.md\necho \"3. **Docstring Quality**: Enhance docstrings to include comprehensive\
        \ descriptions, parameters, returns, and examples\" >> /tmp/documentation_health_report.md\necho \"4. **Consistency**:\
        \ Ensure main README.md references all major subdirectories and their documentation\" >> /tmp/documentation_health_report.md\n\
        echo \"\" >> /tmp/documentation_health_report.md\necho \"## Actions Taken\" >> /tmp/documentation_health_report.md\n\
        echo \"\" >> /tmp/documentation_health_report.md\nif [ \"${{ github.event.inputs.auto_fix }}\" = \"true\" ] || [ \"\
        ${{ github.event_name }}\" = \"schedule\" ]; then\n  echo \"\U0001F916 **Auto-fix enabled**: Missing documentation\
        \ files were automatically created and a PR was opened.\" >> /tmp/documentation_health_report.md\nelse\n  echo \"\u2139\
        \uFE0F **Auto-fix disabled**: Run workflow manually with auto_fix=true to automatically create missing files.\" >>\
        \ /tmp/documentation_health_report.md\nfi\necho \"\" >> /tmp/documentation_health_report.md\necho \"---\" >> /tmp/documentation_health_report.md\n\
        echo \"*This report is generated weekly by the Documentation Maintenance workflow*\" >> /tmp/documentation_health_report.md\n\
        \ncat /tmp/documentation_health_report.md\n"
    - name: Upload documentation reports
      uses: actions/upload-artifact@v4
      with:
        name: documentation-reports
        path: '/tmp/documentation_health_report.md

          /tmp/documentation_report.json

          /tmp/docstring_report.json

          /tmp/missing_docs_report.md

          /tmp/stale_docs_report.md

          /tmp/consistency_report.md

          '
        retention-days: 30
    - name: Create Pull Request with documentation fixes
      if: steps.auto_fix_docs.outputs.changes_made == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'docs: Auto-generate missing documentation files


          This automated commit adds missing README.md, TODO.md, and CHANGELOG.md

          files to directories that lacked them. Files were generated with basic

          templates that should be updated with specific details.


          Generated by: Documentation Maintenance Workflow

          '
        branch: docs/auto-maintenance-${{ github.run_number }}
        delete-branch: true
        title: 'docs: Auto-generate missing documentation files'
        body: "## \U0001F916 Automated Documentation Maintenance\n\nThis PR was automatically created by the [Documentation\
          \ Maintenance workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}).\n\n\
          ### Changes Made\n\n\u2705 Created missing documentation files in directories that lacked them:\n- README.md files\
          \ with basic structure and overview\n- TODO.md files with task tracking templates\n- CHANGELOG.md files with version\
          \ history structure\n\n### Action Required\n\nPlease review the auto-generated files and update them with:\n1. Specific\
          \ module/component descriptions\n2. Usage examples and code snippets\n3. API documentation where applicable\n4.\
          \ Relevant cross-references to related documentation\n\n### Files Created\n\nThe workflow scanned the repository\
          \ and created documentation files in directories\nthat were missing them. All generated files include placeholder\
          \ text that should\nbe customized for the specific module.\n\n---\n\n**Note**: This is an automated PR. The generated\
          \ content is intentionally generic\nand serves as a starting point. Please enhance it with specific details before\
          \ merging.\n\n**Related Issue**: See the [weekly documentation health report](${{ github.server_url }}/${{ github.repository\
          \ }}/issues?q=is%3Aissue+label%3Adocumentation+label%3Aautomated) for more details.\n"
        labels: 'documentation

          automated

          maintenance

          '
        assignees: ${{ github.repository_owner }}
        reviewers: ${{ github.repository_owner }}
    - name: Create or update documentation issue
      uses: actions/github-script@v7
      with:
        script: "const fs = require('fs');\nconst reportPath = '/tmp/documentation_health_report.md';\n\nlet reportContent\
          \ = '';\ntry {\n  reportContent = fs.readFileSync(reportPath, 'utf8');\n} catch (error) {\n  console.log('Could\
          \ not read report file:', error);\n  reportContent = '# Documentation Health Report\\n\\nReport generation failed.\
          \ Please check workflow logs.';\n}\n\n// Check if there's already an open documentation issue\nconst issues = await\
          \ github.rest.issues.listForRepo({\n  owner: context.repo.owner,\n  repo: context.repo.repo,\n  state: 'open',\n\
          \  labels: 'documentation,automated'\n});\n\nconst existingIssue = issues.data.find(issue => \n  issue.title.includes('Weekly\
          \ Documentation Health Report')\n);\n\nconst issueTitle = `Weekly Documentation Health Report - ${new Date().toISOString().split('T')[0]}`;\n\
          const issueBody = `${reportContent}\\n\\n---\\n\\n**Workflow Run:** [#${{ github.run_number }}](${{ github.server_url\
          \ }}/${{ github.repository }}/actions/runs/${{ github.run_id }})`;\n\nif (existingIssue) {\n  // Update existing\
          \ issue\n  await github.rest.issues.createComment({\n    owner: context.repo.owner,\n    repo: context.repo.repo,\n\
          \    issue_number: existingIssue.number,\n    body: `## Update: ${new Date().toISOString().split('T')[0]}\\n\\n${issueBody}`\n\
          \  });\n  console.log(`Updated existing issue #${existingIssue.number}`);\n} else {\n  // Create new issue\n  const\
          \ newIssue = await github.rest.issues.create({\n    owner: context.repo.owner,\n    repo: context.repo.repo,\n \
          \   title: issueTitle,\n    body: issueBody,\n    labels: ['documentation', 'automated', 'maintenance']\n  });\n\
          \  console.log(`Created new issue #${newIssue.data.number}`);\n}\n"
    - name: Add job summary
      if: always()
      run: "echo \"## \U0001F4CA Documentation Maintenance Summary\" >> $GITHUB_STEP_SUMMARY\necho \"\" >> $GITHUB_STEP_SUMMARY\n\
        echo \"**Date:** $(date -u +\"%Y-%m-%d %H:%M:%S UTC\")\" >> $GITHUB_STEP_SUMMARY\necho \"\" >> $GITHUB_STEP_SUMMARY\n\
        \nif [ -f /tmp/documentation_health_report.md ]; then\n  cat /tmp/documentation_health_report.md >> $GITHUB_STEP_SUMMARY\n\
        else\n  echo \"\u26A0\uFE0F Report generation incomplete\" >> $GITHUB_STEP_SUMMARY\nfi\n\necho \"\" >> $GITHUB_STEP_SUMMARY\n\
        echo \"### \U0001F4E6 Artifacts\" >> $GITHUB_STEP_SUMMARY\necho \"- Documentation reports available in workflow artifacts\"\
        \ >> $GITHUB_STEP_SUMMARY\necho \"- Retention: 30 days\" >> $GITHUB_STEP_SUMMARY\n"
  notify-results:
    runs-on:
    - self-hosted
    - linux
    - x64
    timeout-minutes: 45
    container:
      image: python:3.12-slim
      options: --user root
    needs: documentation-audit
    if: always()
    steps:
    - name: Workflow Status Summary
      run: 'echo "## Documentation Maintenance Workflow Complete" >> $GITHUB_STEP_SUMMARY

        echo "" >> $GITHUB_STEP_SUMMARY

        echo "**Status:** ${{ needs.documentation-audit.result }}" >> $GITHUB_STEP_SUMMARY

        echo "**Time:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY

        echo "" >> $GITHUB_STEP_SUMMARY

        echo "Check the [documentation-audit job](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id
        }}) for detailed results." >> $GITHUB_STEP_SUMMARY

        '
