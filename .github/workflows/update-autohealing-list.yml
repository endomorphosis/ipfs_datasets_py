name: Update Auto-Healing Workflow List
true:
  workflow_dispatch: null
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
permissions:
  contents: write
  pull-requests: write
jobs:
  update-workflow-list:
    runs-on:
    - self-hosted
    - linux
    - x64
    timeout-minutes: 45
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 1
        token: ${{ secrets.GITHUB_TOKEN }}
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: pip
    - name: Install dependencies
      run: 'python -m pip install --upgrade pip

        pip install PyYAML

        '
    - name: Update auto-healing workflow list
      run: "echo \"\U0001F4CB Current workflow count in copilot-agent-autofix.yml:\"\ngrep -A 30 \"workflows:\" .github/workflows/copilot-agent-autofix.yml\
        \ | grep '      - \"' | wc -l\n\necho \"\"\necho \"\U0001F504 Running update script...\"\npython3 .github/scripts/update_autofix_workflow_list.py\n\
        \necho \"\"\necho \"\U0001F4CB Updated workflow count:\"\ngrep -A 30 \"workflows:\" .github/workflows/copilot-agent-autofix.yml\
        \ | grep '      - \"' | wc -l\n"
    - name: Check for changes
      id: check_changes
      run: "if git diff --quiet .github/workflows/copilot-agent-autofix.yml; then\n  echo \"has_changes=false\" >> $GITHUB_OUTPUT\n\
        \  echo \"\u2705 No updates needed - workflow list is already up to date\"\nelse\n  echo \"has_changes=true\" >> $GITHUB_OUTPUT\n\
        \  echo \"\U0001F4DD Changes detected in workflow list\"\n  git diff .github/workflows/copilot-agent-autofix.yml\n\
        fi\n"
    - name: Commit changes (main branch only)
      if: steps.check_changes.outputs.has_changes == 'true' && github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: 'git config user.name "github-actions[bot]"

        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"


        git add .github/workflows/copilot-agent-autofix.yml

        git commit -m "chore: Auto-update workflow list in copilot-agent-autofix.yml


        Automatically updated by update-autohealing-list workflow"


        git push

        '
    - name: Create PR comment (PR only)
      if: steps.check_changes.outputs.has_changes == 'true' && github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: "const fs = require('fs');\n\n// Read the current workflow list\nconst workflow_file = fs.readFileSync('.github/workflows/copilot-agent-autofix.yml',\
          \ 'utf8');\nconst workflow_matches = workflow_file.match(/      - \"([^\"]+)\"/g) || [];\nconst workflow_count =\
          \ workflow_matches.length;\n\nconst comment = `## \U0001F504 Auto-Healing Workflow List Update\n\nThe auto-healing\
          \ workflow list needs to be updated to include new or renamed workflows.\n\n**Current workflow count**: ${workflow_count}\
          \ workflows\n\n### Changes Needed\n\nThe \\`copilot-agent-autofix.yml\\` workflow list will be automatically updated\
          \ when this PR is merged.\n\n<details>\n<summary>View updated workflow list</summary>\n\n\\`\\`\\`yaml\n${workflow_matches.join('\\\
          n')}\n\\`\\`\\`\n\n</details>\n\n\u2139\uFE0F This update ensures all workflows are monitored by the auto-healing\
          \ system.\n`;\n\ngithub.rest.issues.createComment({\n  owner: context.repo.owner,\n  repo: context.repo.repo,\n\
          \  issue_number: context.issue.number,\n  body: comment\n});\n"
    - name: Summary
      if: always()
      run: "echo \"## Auto-Healing Workflow List Update\" >> $GITHUB_STEP_SUMMARY\necho \"\" >> $GITHUB_STEP_SUMMARY\n\nif\
        \ [ \"${{ steps.check_changes.outputs.has_changes }}\" = \"true\" ]; then\n  echo \"\U0001F4DD **Status**: Changes\
        \ detected and processed\" >> $GITHUB_STEP_SUMMARY\n  \n  if [ \"${{ github.event_name }}\" = \"push\" ] && [ \"${{\
        \ github.ref }}\" = \"refs/heads/main\" ]; then\n    echo \"\u2705 **Action**: Committed and pushed to main branch\"\
        \ >> $GITHUB_STEP_SUMMARY\n  elif [ \"${{ github.event_name }}\" = \"pull_request\" ]; then\n    echo \"\U0001F4AC\
        \ **Action**: Comment added to PR\" >> $GITHUB_STEP_SUMMARY\n  else\n    echo \"\u2139\uFE0F  **Action**: No action\
        \ taken (not main branch)\" >> $GITHUB_STEP_SUMMARY\n  fi\nelse\n  echo \"\u2705 **Status**: No changes needed - list\
        \ is up to date\" >> $GITHUB_STEP_SUMMARY\nfi\n\necho \"\" >> $GITHUB_STEP_SUMMARY\necho \"### Monitored Workflows\"\
        \ >> $GITHUB_STEP_SUMMARY\necho \"\" >> $GITHUB_STEP_SUMMARY\npython3 .github/scripts/generate_workflow_list.py |\
        \ while read -r line; do\n  echo \"- $line\" >> $GITHUB_STEP_SUMMARY\ndone\n"
