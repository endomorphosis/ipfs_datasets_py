name: Docker Permission Fix for Self-Hosted Runners

on:
  workflow_dispatch:
    inputs:
      fix_type:
        description: 'Type of fix to apply'
        required: true
        default: 'diagnose'
        type: choice
        options:
          - diagnose
          - fix_permissions
          - test_docker

env:
  DOCKER_BUILDKIT: 1

jobs:
  diagnose-docker-permissions:
    runs-on: [self-hosted]
    if: github.event.inputs.fix_type == 'diagnose' || github.event.inputs.fix_type == 'fix_permissions'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Docker Permission Diagnostics
        run: |
          echo "## ðŸ” Docker Permission Diagnostics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Current User Information"
          echo "- **User**: $(whoami)" >> $GITHUB_STEP_SUMMARY
          echo "- **UID**: $(id -u)" >> $GITHUB_STEP_SUMMARY
          echo "- **GID**: $(id -g)" >> $GITHUB_STEP_SUMMARY
          echo "- **Groups**: $(groups)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Docker Socket Information"
          echo '```' >> $GITHUB_STEP_SUMMARY
          ls -la /var/run/docker.sock >> $GITHUB_STEP_SUMMARY 2>&1 || echo "Docker socket not found" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Docker Group Members"
          echo '```' >> $GITHUB_STEP_SUMMARY
          getent group docker >> $GITHUB_STEP_SUMMARY 2>&1 || echo "Docker group not found" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Docker Access Test"
          if docker ps >/dev/null 2>&1; then
            echo "âœ… **Docker access: WORKING**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            docker version >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Docker access: FAILED**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            docker ps 2>&1 >> $GITHUB_STEP_SUMMARY || true
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
      
      - name: Runner Service Information
        run: |
          echo "### Runner Service Information" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          # Find runner services
          echo "Active runner services:" >> $GITHUB_STEP_SUMMARY
          systemctl list-units --type=service | grep -E "(actions\.runner|github.*runner)" >> $GITHUB_STEP_SUMMARY || echo "No runner services found" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Runner processes:" >> $GITHUB_STEP_SUMMARY
          ps aux | grep -E "(Runner|github)" | head -5 >> $GITHUB_STEP_SUMMARY || echo "No runner processes found" >> $GITHUB_STEP_SUMMARY
          
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
      
      - name: Suggested Fixes
        if: failure() || success()
        run: |
          echo "### ðŸ”§ Suggested Fixes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if ! docker ps >/dev/null 2>&1; then
            echo "Docker access is failing. Try these solutions:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### Solution 1: Add user to docker group" >> $GITHUB_STEP_SUMMARY
            echo '```bash' >> $GITHUB_STEP_SUMMARY
            echo "sudo usermod -aG docker $(whoami)" >> $GITHUB_STEP_SUMMARY
            echo "# Then restart the runner service" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### Solution 2: Use the automated fix script" >> $GITHUB_STEP_SUMMARY
            echo '```bash' >> $GITHUB_STEP_SUMMARY
            echo "sudo ./scripts/setup-runner-docker-permissions.sh" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### Solution 3: Manual systemd service fix" >> $GITHUB_STEP_SUMMARY
            echo '```bash' >> $GITHUB_STEP_SUMMARY
            echo "# Find your runner service" >> $GITHUB_STEP_SUMMARY
            echo "systemctl list-units | grep runner" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "# Add user to docker group and restart service" >> $GITHUB_STEP_SUMMARY
            echo "sudo systemctl restart actions.runner.*" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Docker access is working correctly!" >> $GITHUB_STEP_SUMMARY
          fi

  fix-docker-permissions:
    runs-on: [self-hosted]
    if: github.event.inputs.fix_type == 'fix_permissions'
    needs: diagnose-docker-permissions
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Apply Docker Permission Fix
        run: |
          echo "## ðŸ”§ Applying Docker Permission Fix" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ -f "./scripts/setup-runner-docker-permissions.sh" ]]; then
            echo "Running automated fix script..." >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            sudo ./scripts/setup-runner-docker-permissions.sh --user $(whoami) >> $GITHUB_STEP_SUMMARY 2>&1 || true
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "Manual fix approach..." >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            
            # Add current user to docker group (if not already)
            if ! groups $(whoami) | grep -q docker; then
              echo "Adding $(whoami) to docker group..." >> $GITHUB_STEP_SUMMARY
              sudo usermod -aG docker $(whoami) >> $GITHUB_STEP_SUMMARY 2>&1
            else
              echo "User $(whoami) is already in docker group" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "âš ï¸ **Note**: Runner service may need to be restarted manually for changes to take effect." >> $GITHUB_STEP_SUMMARY

  test-docker-after-fix:
    runs-on: [self-hosted]
    if: github.event.inputs.fix_type == 'test_docker'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Test Basic Docker Commands
        run: |
          echo "## ðŸ§ª Testing Docker Commands" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Test docker version
          echo "### Docker Version" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          docker --version >> $GITHUB_STEP_SUMMARY 2>&1 || echo "docker --version failed" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Test docker info
          echo "### Docker Info" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          docker info >> $GITHUB_STEP_SUMMARY 2>&1 || echo "docker info failed" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
      
      - name: Test Docker Build
        run: |
          echo "### Docker Build Test" >> $GITHUB_STEP_SUMMARY
          
          # Create a simple test Dockerfile
          cat > Dockerfile.test-permissions << 'EOF'
          FROM alpine:latest
          RUN echo "Docker build test successful" > /test-result.txt
          CMD ["cat", "/test-result.txt"]
          EOF
          
          echo '```' >> $GITHUB_STEP_SUMMARY
          if docker build -t test-permissions -f Dockerfile.test-permissions . >> $GITHUB_STEP_SUMMARY 2>&1; then
            echo "âœ… Docker build: SUCCESS" >> $GITHUB_STEP_SUMMARY
            
            # Test running the container
            if docker run --rm test-permissions >> $GITHUB_STEP_SUMMARY 2>&1; then
              echo "âœ… Docker run: SUCCESS" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ Docker run: FAILED" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Cleanup
            docker rmi test-permissions >> $GITHUB_STEP_SUMMARY 2>&1 || true
          else
            echo "âŒ Docker build: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Cleanup test files
          rm -f Dockerfile.test-permissions
      
      - name: Test Project Docker Build
        run: |
          echo "### Project Docker Build Test" >> $GITHUB_STEP_SUMMARY
          
          if [[ -f "Dockerfile.test" ]]; then
            echo "Testing with Dockerfile.test..." >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            
            if docker build -t ipfs-datasets-test -f Dockerfile.test . >> $GITHUB_STEP_SUMMARY 2>&1; then
              echo "âœ… Project Docker build: SUCCESS" >> $GITHUB_STEP_SUMMARY
              
              # Test basic import
              if docker run --rm ipfs-datasets-test python -c "import ipfs_datasets_py; print('Package import successful')" >> $GITHUB_STEP_SUMMARY 2>&1; then
                echo "âœ… Package import test: SUCCESS" >> $GITHUB_STEP_SUMMARY
              else
                echo "âŒ Package import test: FAILED" >> $GITHUB_STEP_SUMMARY
              fi
              
              # Cleanup
              docker rmi ipfs-datasets-test >> $GITHUB_STEP_SUMMARY 2>&1 || true
            else
              echo "âŒ Project Docker build: FAILED" >> $GITHUB_STEP_SUMMARY
            fi
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "No Dockerfile.test found, skipping project build test" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

  summary:
    runs-on: ubuntu-latest
    needs: [diagnose-docker-permissions, fix-docker-permissions, test-docker-after-fix]
    if: always()
    
    steps:
      - name: Summary
        run: |
          echo "## ðŸ“‹ Docker Permission Fix Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Diagnostics | ${{ needs.diagnose-docker-permissions.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Fix Permissions | ${{ needs.fix-docker-permissions.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Docker | ${{ needs.test-docker-after-fix.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.test-docker-after-fix.result }}" == "success" ]]; then
            echo "âœ… **Docker permissions are working correctly!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Docker permission issues may still exist.**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
            echo "1. Check the diagnostic output above" >> $GITHUB_STEP_SUMMARY
            echo "2. Manually restart the runner service" >> $GITHUB_STEP_SUMMARY
            echo "3. Contact system administrator if issues persist" >> $GITHUB_STEP_SUMMARY
          fi