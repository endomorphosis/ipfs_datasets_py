name: MCP Tools Error Monitoring
true:
  push:
    branches:
    - main
    - develop
    paths:
    - ipfs_datasets_py/mcp_server/tools/**
    - ipfs_datasets_py/mcp_tools/**
    - .github/workflows/mcp-tools-monitoring.yml
  pull_request:
    branches:
    - main
    - develop
  workflow_dispatch:
    inputs:
      category:
        description: Tool category to test (or "all")
        required: true
        default: all
        type: string
      test_mode:
        description: Test mode
        required: true
        default: comprehensive
        type: choice
        options:
        - basic
        - comprehensive
        - category
  schedule:
  - cron: 0 6 * * *
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
permissions:
  contents: read
  issues: write
  actions: read
env:
  PYTHON_VERSION: '3.12'
  ERROR_REPORTING_ENABLED: 'true'
jobs:
  discover-tool-categories:
    runs-on:
    - self-hosted
    - linux
    - x64
    timeout-minutes: 45
    container:
      image: python:3.12-slim
      options: --user root
    outputs:
      categories: ${{ steps.discover.outputs.categories }}
      category_count: ${{ steps.discover.outputs.category_count }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 1
        submodules: false
    - name: Discover Tool Categories
      id: discover
      run: "echo \"\U0001F50D Discovering MCP tool categories...\"\n\n# Find all tool categories\ncategories=$(find ipfs_datasets_py/mcp_server/tools\
        \ -maxdepth 1 -type d -not -path \"*/\\.*\" -not -name tools -not -name __pycache__ | sort)\n\ncount=0\ncategory_list=\"\
        \"\n\nfor dir in $categories; do\n  category_name=$(basename \"$dir\")\n  if [ \"$category_name\" != \"__pycache__\"\
        \ ] && [ \"$category_name\" != \".\" ]; then\n    tool_count=$(find \"$dir\" -name \"*.py\" -not -name \"__init__.py\"\
        \ -not -name \"test_*\" | wc -l)\n    echo \"  \U0001F4C1 $category_name ($tool_count tools)\"\n    count=$((count\
        \ + 1))\n    if [ -z \"$category_list\" ]; then\n      category_list=\"$category_name\"\n    else\n      category_list=\"\
        $category_list,$category_name\"\n    fi\n  fi\ndone\n\necho \"Found $count tool categories\"\necho \"categories=$category_list\"\
        \ >> $GITHUB_OUTPUT\necho \"category_count=$count\" >> $GITHUB_OUTPUT\n\necho \"## \U0001F4DA MCP Tool Categories\"\
        \ >> $GITHUB_STEP_SUMMARY\necho \"\" >> $GITHUB_STEP_SUMMARY\necho \"Discovered **$count** tool categories\" >> $GITHUB_STEP_SUMMARY\n"
  test-tool-loading:
    runs-on:
    - self-hosted
    - linux
    - x64
    timeout-minutes: 45
    container:
      image: python:3.12-slim
      options: --user root
    needs: discover-tool-categories
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 1
        submodules: false
    - name: Install dependencies
      run: 'apt-get update

        apt-get install -y git

        pip install --upgrade pip

        pip install -e .[test]

        '
    - name: Test Tool Discovery
      id: tool_discovery
      continue-on-error: true
      run: "echo \"\U0001F527 Testing tool discovery...\"\n\npython -c \"\nfrom pathlib import Path\nimport importlib.util\n\
        import sys\n\ntools_dir = Path('ipfs_datasets_py/mcp_server/tools')\ntotal_tools = 0\nfailed_tools = []\n\nfor category_dir\
        \ in tools_dir.iterdir():\n    if not category_dir.is_dir() or category_dir.name.startswith('_'):\n        continue\n\
        \    \n    category_name = category_dir.name\n    print(f'\\n\U0001F4C1 Testing {category_name}...')\n    \n    for\
        \ tool_file in category_dir.glob('*.py'):\n        if tool_file.name.startswith('_') or tool_file.name == '__init__.py':\n\
        \            continue\n        \n        tool_name = tool_file.stem\n        total_tools += 1\n        \n        #\
        \ Try to load the module\n        try:\n            module_name = f'ipfs_datasets_py.mcp_server.tools.{category_name}.{tool_name}'\n\
        \            spec = importlib.util.spec_from_file_location(module_name, tool_file)\n            if spec and spec.loader:\n\
        \                module = importlib.util.module_from_spec(spec)\n                sys.modules[module_name] = module\n\
        \                spec.loader.exec_module(module)\n                print(f'  \u2705 {tool_name}')\n            else:\n\
        \                print(f'  \u274C {tool_name} - Could not create module spec')\n                failed_tools.append(f'{category_name}/{tool_name}')\n\
        \        except Exception as e:\n            print(f'  \u274C {tool_name} - {type(e).__name__}: {str(e)[:100]}')\n\
        \            failed_tools.append(f'{category_name}/{tool_name}')\n\nprint(f'\\n\U0001F4CA Summary:')\nprint(f'  Total\
        \ tools: {total_tools}')\nprint(f'  Loaded successfully: {total_tools - len(failed_tools)}')\nprint(f'  Failed to\
        \ load: {len(failed_tools)}')\n\nif failed_tools:\n    print(f'\\n\u274C Failed tools:')\n    for tool in failed_tools:\n\
        \        print(f'  - {tool}')\n    sys.exit(1)\nelse:\n    print('\\n\u2705 All tools loaded successfully')\n\" ||\
        \ echo \"tool_loading_failed=true\" >> $GITHUB_OUTPUT\n"
    - name: Report Tool Loading Issues
      if: steps.tool_discovery.outputs.tool_loading_failed == 'true'
      run: "echo \"## \u274C Tool Loading Failures\" >> $GITHUB_STEP_SUMMARY\necho \"\" >> $GITHUB_STEP_SUMMARY\necho \"Some\
        \ MCP tools failed to load. Auto-healing will be triggered.\" >> $GITHUB_STEP_SUMMARY\n"
  test-tool-execution:
    runs-on:
    - self-hosted
    - linux
    - x64
    timeout-minutes: 45
    container:
      image: python:3.12-slim
      options: --user root
    needs:
    - discover-tool-categories
    - test-tool-loading
    if: ${{ !cancelled() }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 1
        submodules: false
    - name: Install dependencies
      run: 'apt-get update

        apt-get install -y git curl

        pip install --upgrade pip

        pip install -e .[test,all]

        '
    - name: Start MCP Server
      run: "echo \"\U0001F680 Starting MCP server...\"\npython -m ipfs_datasets_py.mcp_dashboard &\nMCP_PID=$!\necho \"MCP_DASHBOARD_PID=$MCP_PID\"\
        \ >> $GITHUB_ENV\n\n# Wait for server to be ready\nfor i in {1..60}; do\n  if curl -f http://127.0.0.1:8899/api/mcp/status\
        \ 2>/dev/null; then\n    echo \"\u2705 MCP server is ready!\"\n    break\n  fi\n  if [ $i -eq 60 ]; then\n    echo\
        \ \"\u274C MCP server failed to start\"\n    exit 1\n  fi\n  sleep 2\ndone\n"
    - name: Test Tool Availability via API
      id: tool_availability
      continue-on-error: true
      run: "echo \"\U0001F9EA Testing tool availability...\"\n\n# Get list of available tools\nTOOLS=$(curl -s http://127.0.0.1:8899/api/mcp/tools)\n\
        \nif [ -z \"$TOOLS\" ] || [ \"$TOOLS\" = \"null\" ]; then\n  echo \"\u274C No tools available from API\"\n  echo \"\
        tool_availability_failed=true\" >> $GITHUB_OUTPUT\n  exit 1\nfi\n\n# Count tools\nTOOL_COUNT=$(echo \"$TOOLS\" | python3\
        \ -c \"import sys, json; data = json.load(sys.stdin); print(len(data) if isinstance(data, list) else len(data.get('tools',\
        \ [])))\" 2>/dev/null || echo \"0\")\n\necho \"Found $TOOL_COUNT tools via API\"\n\nif [ \"$TOOL_COUNT\" -lt 10 ];\
        \ then\n  echo \"\u26A0\uFE0F Expected more tools, found only $TOOL_COUNT\"\n  echo \"tool_availability_warning=true\"\
        \ >> $GITHUB_OUTPUT\nelse\n  echo \"\u2705 Tool availability looks good ($TOOL_COUNT tools)\"\nfi\n"
    - name: Test Sample Tool Execution
      id: tool_execution
      continue-on-error: true
      run: "echo \"\U0001F527 Testing sample tool execution...\"\n\n# Test a simple tool (if available)\npython -c \"\nimport\
        \ requests\nimport json\n\n# Try to execute a simple info tool\ntry:\n    # Get list of tools first\n    response\
        \ = requests.get('http://127.0.0.1:8899/api/mcp/tools', timeout=10)\n    tools = response.json()\n    \n    print(f'Available\
        \ for testing: {len(tools) if isinstance(tools, list) else len(tools.get(\\\"tools\\\", []))} tools')\n    \n    #\
        \ Try to get status\n    response = requests.get('http://127.0.0.1:8899/api/mcp/status', timeout=10)\n    status =\
        \ response.json()\n    \n    if response.status_code == 200:\n        print('\u2705 MCP server status endpoint working')\n\
        \    else:\n        print(f'\u26A0\uFE0F Status endpoint returned {response.status_code}')\n    \n    print('\u2705\
        \ Sample tool execution test passed')\n    \nexcept Exception as e:\n    print(f'\u274C Tool execution test failed:\
        \ {e}')\n    import sys\n    sys.exit(1)\n\" || echo \"tool_execution_failed=true\" >> $GITHUB_OUTPUT\n"
    - name: Stop MCP Server
      if: always()
      run: "if [ ! -z \"$MCP_DASHBOARD_PID\" ]; then\n  kill $MCP_DASHBOARD_PID || true\nfi\npkill -f \"mcp_dashboard\" ||\
        \ true\n"
  test-tool-categories:
    runs-on:
    - self-hosted
    - linux
    - x64
    timeout-minutes: 45
    container:
      image: python:3.12-slim
      options: --user root
    needs:
    - discover-tool-categories
    - test-tool-loading
    if: ${{ !cancelled() && github.event.inputs.test_mode == 'category' && github.event.inputs.category != 'all' }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 1
        submodules: false
    - name: Install dependencies
      run: 'apt-get update

        apt-get install -y git

        pip install --upgrade pip

        pip install -e .[test]

        '
    - name: Test Category Tools
      run: "echo \"\U0001F527 Testing category: ${{ github.event.inputs.category }}\"\n\nCATEGORY=\"${{ github.event.inputs.category\
        \ }}\"\nCATEGORY_DIR=\"ipfs_datasets_py/mcp_server/tools/$CATEGORY\"\n\nif [ ! -d \"$CATEGORY_DIR\" ]; then\n  echo\
        \ \"\u274C Category directory not found: $CATEGORY_DIR\"\n  exit 1\nfi\n\npython -c \"\nfrom pathlib import Path\n\
        import importlib.util\nimport sys\n\ncategory = '$CATEGORY'\ncategory_dir = Path('ipfs_datasets_py/mcp_server/tools')\
        \ / category\n\nprint(f'Testing tools in category: {category}')\n\nfailed_tools = []\n\nfor tool_file in category_dir.glob('*.py'):\n\
        \    if tool_file.name.startswith('_') or tool_file.name == '__init__.py':\n        continue\n    \n    tool_name\
        \ = tool_file.stem\n    \n    try:\n        module_name = f'ipfs_datasets_py.mcp_server.tools.{category}.{tool_name}'\n\
        \        spec = importlib.util.spec_from_file_location(module_name, tool_file)\n        if spec and spec.loader:\n\
        \            module = importlib.util.module_from_spec(spec)\n            sys.modules[module_name] = module\n     \
        \       spec.loader.exec_module(module)\n            print(f'  \u2705 {tool_name}')\n        else:\n            print(f'\
        \  \u274C {tool_name} - Could not create module spec')\n            failed_tools.append(tool_name)\n    except Exception\
        \ as e:\n        print(f'  \u274C {tool_name} - {type(e).__name__}: {str(e)[:100]}')\n        failed_tools.append(tool_name)\n\
        \nif failed_tools:\n    print(f'\\n\u274C Failed tools in {category}:')\n    for tool in failed_tools:\n        print(f'\
        \  - {tool}')\n    sys.exit(1)\nelse:\n    print(f'\\n\u2705 All tools in {category} loaded successfully')\n\"\n"
  test-error-reporting:
    runs-on:
    - self-hosted
    - linux
    - x64
    timeout-minutes: 45
    container:
      image: python:3.12-slim
      options: --user root
    needs: test-tool-loading
    if: ${{ !cancelled() }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 1
        submodules: false
    - name: Install dependencies
      run: 'apt-get update

        apt-get install -y git

        pip install --upgrade pip

        pip install -e .[test]

        '
    - name: Test MCP Tool Error Capture
      run: "echo \"\U0001F9EA Testing MCP tool error reporting...\"\n\npython -c \"\nfrom ipfs_datasets_py.error_reporting.error_reporter\
        \ import ErrorReporter\n\n# Test error reporter\nreporter = ErrorReporter(enabled=False)  # Disabled for testing\n\
        \nprint('\u2705 Error reporter initialized')\n\n# Test error formatting for MCP tools\ntry:\n    raise RuntimeError('Test\
        \ MCP tool error')\nexcept Exception as e:\n    import traceback\n    error_hash = reporter._compute_error_hash(\n\
        \        error_type=type(e).__name__,\n        error_message=str(e),\n        error_location='test_location'\n   \
        \ )\n    \n    print(f'\u2705 Error hash computed: {error_hash}')\n    \n    # Test deduplication\n    should_report\
        \ = reporter._should_report_error(error_hash)\n    print(f'\u2705 Should report: {should_report}')\n\nprint('\u2705\
        \ MCP tool error reporting test passed')\n\"\n"
  comprehensive-tool-health:
    runs-on:
    - self-hosted
    - linux
    - x64
    timeout-minutes: 45
    container:
      image: python:3.12-slim
      options: --user root
    needs:
    - discover-tool-categories
    - test-tool-loading
    - test-tool-execution
    if: ${{ !cancelled() && github.event.inputs.test_mode == 'comprehensive' }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 1
        submodules: false
    - name: Install dependencies
      run: 'apt-get update

        apt-get install -y git curl

        pip install --upgrade pip

        pip install -e .[test,all]

        '
    - name: Run Comprehensive Health Check
      run: "echo \"\U0001F3E5 Running comprehensive MCP tools health check...\"\n\npython -c \"\nfrom pathlib import Path\n\
        import importlib.util\nimport sys\nimport json\n\ntools_dir = Path('ipfs_datasets_py/mcp_server/tools')\n\nhealth_report\
        \ = {\n    'total_categories': 0,\n    'total_tools': 0,\n    'loaded_tools': 0,\n    'failed_tools': [],\n    'categories':\
        \ {}\n}\n\nfor category_dir in tools_dir.iterdir():\n    if not category_dir.is_dir() or category_dir.name.startswith('_'):\n\
        \        continue\n    \n    category_name = category_dir.name\n    health_report['total_categories'] += 1\n    health_report['categories'][category_name]\
        \ = {\n        'total': 0,\n        'loaded': 0,\n        'failed': []\n    }\n    \n    for tool_file in category_dir.glob('*.py'):\n\
        \        if tool_file.name.startswith('_') or tool_file.name == '__init__.py':\n            continue\n        \n \
        \       tool_name = tool_file.stem\n        health_report['total_tools'] += 1\n        health_report['categories'][category_name]['total']\
        \ += 1\n        \n        try:\n            module_name = f'ipfs_datasets_py.mcp_server.tools.{category_name}.{tool_name}'\n\
        \            spec = importlib.util.spec_from_file_location(module_name, tool_file)\n            if spec and spec.loader:\n\
        \                module = importlib.util.module_from_spec(spec)\n                sys.modules[module_name] = module\n\
        \                spec.loader.exec_module(module)\n                health_report['loaded_tools'] += 1\n           \
        \     health_report['categories'][category_name]['loaded'] += 1\n            else:\n                health_report['failed_tools'].append(f'{category_name}/{tool_name}')\n\
        \                health_report['categories'][category_name]['failed'].append(tool_name)\n        except Exception\
        \ as e:\n            health_report['failed_tools'].append(f'{category_name}/{tool_name}')\n            health_report['categories'][category_name]['failed'].append(tool_name)\n\
        \n# Save report\nwith open('mcp_tools_health_report.json', 'w') as f:\n    json.dump(health_report, f, indent=2)\n\
        \n# Print summary\nprint(f'\\n\U0001F4CA MCP Tools Health Report:')\nprint(f'  Categories: {health_report[\\\"total_categories\\\
        \"]}')\nprint(f'  Total Tools: {health_report[\\\"total_tools\\\"]}')\nprint(f'  Loaded: {health_report[\\\"loaded_tools\\\
        \"]}')\nprint(f'  Failed: {len(health_report[\\\"failed_tools\\\"])}')\n\nif health_report['failed_tools']:\n    print(f'\\\
        n\u274C Failed tools:')\n    for tool in health_report['failed_tools']:\n        print(f'  - {tool}')\n    sys.exit(1)\n\
        else:\n    print('\\n\u2705 All MCP tools are healthy')\n\"\n"
    - name: Upload Health Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: mcp-tools-health-report
        path: mcp_tools_health_report.json
  mcp-tools-monitoring-summary:
    runs-on:
    - self-hosted
    - linux
    - x64
    timeout-minutes: 30
    container:
      image: python:3.12-slim
      options: --user root
    needs:
    - discover-tool-categories
    - test-tool-loading
    - test-tool-execution
    - test-error-reporting
    if: always()
    steps:
    - name: Generate Summary
      run: "echo \"## \U0001F527 MCP Tools Error Monitoring Results\" >> $GITHUB_STEP_SUMMARY\necho \"\" >> $GITHUB_STEP_SUMMARY\n\
        echo \"### Test Suite Results\" >> $GITHUB_STEP_SUMMARY\necho \"\" >> $GITHUB_STEP_SUMMARY\necho \"| Test Suite |\
        \ Status | Description |\" >> $GITHUB_STEP_SUMMARY\necho \"|------------|--------|-------------|\" >> $GITHUB_STEP_SUMMARY\n\
        echo \"| Tool Discovery | ${{ needs.discover-tool-categories.result }} | Found ${{ needs.discover-tool-categories.outputs.category_count\
        \ }} categories |\" >> $GITHUB_STEP_SUMMARY\necho \"| Tool Loading | ${{ needs.test-tool-loading.result }} | Module\
        \ import and initialization |\" >> $GITHUB_STEP_SUMMARY\necho \"| Tool Execution | ${{ needs.test-tool-execution.result\
        \ }} | API availability and execution |\" >> $GITHUB_STEP_SUMMARY\necho \"| Error Reporting | ${{ needs.test-error-reporting.result\
        \ }} | Error capture integration |\" >> $GITHUB_STEP_SUMMARY\necho \"\" >> $GITHUB_STEP_SUMMARY\n\n# Add analysis\n\
        echo \"### Analysis\" >> $GITHUB_STEP_SUMMARY\necho \"\" >> $GITHUB_STEP_SUMMARY\n\nif [ \"${{ needs.test-tool-loading.result\
        \ }}\" = \"success\" ]; then\n  echo \"\u2705 **Tool Loading**: All MCP tools loaded successfully\" >> $GITHUB_STEP_SUMMARY\n\
        else\n  echo \"\u274C **Tool Loading**: Some tools failed to load - auto-healing triggered\" >> $GITHUB_STEP_SUMMARY\n\
        fi\n\nif [ \"${{ needs.test-tool-execution.result }}\" = \"success\" ]; then\n  echo \"\u2705 **Tool Execution**:\
        \ MCP server and tools are functional\" >> $GITHUB_STEP_SUMMARY\nelse\n  echo \"\u26A0\uFE0F **Tool Execution**: Issues\
        \ with tool execution - auto-healing triggered\" >> $GITHUB_STEP_SUMMARY\nfi\n\nif [ \"${{ needs.test-error-reporting.result\
        \ }}\" = \"success\" ]; then\n  echo \"\u2705 **Error Reporting**: MCP tool error capture working\" >> $GITHUB_STEP_SUMMARY\n\
        else\n  echo \"\u26A0\uFE0F **Error Reporting**: Issues with error reporting system\" >> $GITHUB_STEP_SUMMARY\nfi\n\
        \necho \"\" >> $GITHUB_STEP_SUMMARY\necho \"### Auto-Healing Integration\" >> $GITHUB_STEP_SUMMARY\necho \"- Failed\
        \ workflows trigger copilot-agent-autofix\" >> $GITHUB_STEP_SUMMARY\necho \"- GitHub issues created for tool failures\"\
        \ >> $GITHUB_STEP_SUMMARY\necho \"- Draft PRs generated with Copilot fixes\" >> $GITHUB_STEP_SUMMARY\n"
