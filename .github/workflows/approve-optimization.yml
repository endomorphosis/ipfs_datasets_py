name: Approve and Merge Optimization

on:
  pull_request_review:
    types: [submitted]
  
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to approve and merge'
        required: true
        type: number


concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  approve-optimization:
    if: |
      (github.event_name == 'pull_request_review' && 
       github.event.review.state == 'approved' &&
       contains(github.event.pull_request.labels.*.name, 'automated')) ||
      github.event_name == 'workflow_dispatch'
    
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 1
          ref: ${{ github.event.pull_request.head.ref || format('automated-optimization-{0}', github.event.inputs.pr_number) }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[test]"
      
      - name: Run final validation
        id: validate
        run: |
          echo "Running final validation..."
          
          # Get list of changed Python files
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            PR_NUMBER=${{ github.event.inputs.pr_number }}
          else
            PR_NUMBER=${{ github.event.pull_request.number }}
          fi
          
          gh pr view $PR_NUMBER --json files --jq '.files[].path' | \
            grep '\.py$' > changed_files.txt || true
          
          VALIDATION_FAILED=0
          
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              echo "Validating $file..."
              if ! python -m ipfs_datasets_py.optimizers.agentic.cli validate "$file" --level strict; then
                echo "::error::Validation failed for $file"
                VALIDATION_FAILED=1
              fi
            fi
          done < changed_files.txt
          
          if [ $VALIDATION_FAILED -eq 0 ]; then
            echo "validation_passed=true" >> $GITHUB_OUTPUT
          else
            echo "validation_passed=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Run tests
        if: steps.validate.outputs.validation_passed == 'true'
        run: |
          echo "Running tests on changed code..."
          pytest tests/ -v --tb=short -x || {
            echo "::error::Tests failed"
            exit 1
          }
      
      - name: Check performance
        if: steps.validate.outputs.validation_passed == 'true'
        run: |
          echo "## Performance Check" >> $GITHUB_STEP_SUMMARY
          echo "Checking if optimization improved performance..." >> $GITHUB_STEP_SUMMARY
          
          # Get optimization statistics
          python -m ipfs_datasets_py.optimizers.agentic.cli stats >> $GITHUB_STEP_SUMMARY 2>&1 || true
      
      - name: Update metrics
        if: steps.validate.outputs.validation_passed == 'true'
        run: |
          echo "## Optimization Metrics" >> $GITHUB_STEP_SUMMARY
          
          # Collect metrics
          echo "- ‚úÖ Final validation: PASSED" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Tests: PASSED" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Ready for merge" >> $GITHUB_STEP_SUMMARY
      
      - name: Auto-merge PR
        if: steps.validate.outputs.validation_passed == 'true' && github.event.review.state == 'approved'
        uses: actions/github-script@v7
        with:
          script: |
            const pr_number = context.payload.pull_request.number;
            
            try {
              // Enable auto-merge
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr_number,
                merge_method: 'squash',
                commit_title: `ü§ñ Automated optimization (#${pr_number})`,
                commit_message: `
                Automated code optimization approved and merged.
                
                All validations passed:
                - Final validation: ‚úÖ
                - Tests: ‚úÖ
                - Performance check: ‚úÖ
                
                Generated by agentic optimizer workflow.
                `
              });
              
              console.log(`Successfully merged PR #${pr_number}`);
              
              // Add success comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr_number,
                body: `‚úÖ Optimization approved and automatically merged!
                
                All validation checks passed. Changes are now in the main branch.`
              });
              
            } catch (error) {
              console.error('Error merging PR:', error);
              core.setFailed(\`Failed to merge PR: \${error.message}\`);
            }
      
      - name: Report validation failure
        if: steps.validate.outputs.validation_passed == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const pr_number = context.payload.pull_request?.number || ${{ github.event.inputs.pr_number }};
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr_number,
              body: `‚ùå Final validation failed.
              
              The optimization could not be automatically merged due to validation failures.
              Please review the workflow logs and fix any issues.
              
              Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`
            });
            
            core.setFailed('Final validation failed');
      
      - name: Clean up on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const pr_number = context.payload.pull_request?.number || ${{ github.event.inputs.pr_number }};
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr_number,
              body: `‚ö†Ô∏è Automated merge workflow encountered an error.
              
              Please check the workflow logs:
              ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
              
              The PR may need to be merged manually after addressing any issues.`
            });
