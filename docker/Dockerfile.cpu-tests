# Dockerfile for CPU-only tests
FROM python:3.12-slim

# Install system dependencies
RUN apt-get update && apt-get install -y \
    git \
    curl \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy application files
COPY setup.py README.md ./
COPY ipfs_datasets_py/ ./ipfs_datasets_py/
COPY tests/ ./tests/

# Install package with test dependencies
RUN pip install --no-cache-dir -e .[test] && \
    pip install --no-cache-dir pytest pytest-cov

# Set environment variables
ENV PYTHONUNBUFFERED=1

# Run CPU tests by default
CMD ["pytest", "tests/", "-v", "-m", "not gpu", \
     "--cov=ipfs_datasets_py", \
     "--cov-report=xml", \
     "--cov-report=term", \
     "--junit-xml=/app/test-results/cpu-test-results.xml"]
