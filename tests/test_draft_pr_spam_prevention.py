#!/usr/bin/env python3
"""
Test Draft PR Spam Prevention

This test validates that the fixes prevent the auto-healing system from
creating 100+ draft PRs overnight.
"""

import sys
import json


def test_auto_generated_detection():
    """Test that auto-generated issues are correctly detected."""
    print("="*80)
    print("Test 1: Auto-Generated Issue Detection")
    print("="*80)
    
    test_cases = [
        {
            "name": "Auto-healing workflow issue",
            "title": "Fix: Docker Build and Test workflow failure (Run 12345)",
            "body": "Auto-generated by: Workflow Auto-Healing System\nRun ID: 12345",
            "should_skip": True
        },
        {
            "name": "Another auto-healing issue",
            "title": "Fix: GPU-Enabled Tests workflow failure (Run 67890)",
            "body": "This is an automated workflow failure detected by the auto-healing system.",
            "should_skip": True
        },
        {
            "name": "Manual issue with Fix prefix",
            "title": "Fix: Bug in user interface",
            "body": "There is a bug in the UI that needs to be fixed manually.",
            "should_skip": False
        },
        {
            "name": "Regular issue",
            "title": "Add new feature to dashboard",
            "body": "We need to implement a new dashboard feature.",
            "should_skip": False
        },
        {
            "name": "Issue about workflow but not auto-generated",
            "title": "Improve workflow performance",
            "body": "We should make the CI workflows faster.",
            "should_skip": False
        }
    ]
    
    passed = 0
    failed = 0
    
    for case in test_cases:
        print(f"\n  Testing: {case['name']}")
        print(f"    Title: {case['title'][:60]}")
        
        # Detection logic from workflow
        is_auto_generated = False
        if "Fix:" in case['title'] or "workflow failure" in case['title']:
            if any(keyword in case['body'] for keyword in ["Auto-generated", "auto-healing", "automated workflow"]):
                is_auto_generated = True
        
        expected = case['should_skip']
        
        if is_auto_generated == expected:
            print(f"    ‚úÖ PASS: {'Skipped' if is_auto_generated else 'Processed'} (expected)")
            passed += 1
        else:
            print(f"    ‚ùå FAIL: {'Skipped' if is_auto_generated else 'Processed'} (expected {'skip' if expected else 'process'})")
            failed += 1
    
    print(f"\n  Results: {passed} passed, {failed} failed")
    return failed == 0


def test_rate_limiting():
    """Test that rate limiting prevents spam."""
    print("\n" + "="*80)
    print("Test 2: Rate Limiting (Max 10 PRs/hour)")
    print("="*80)
    
    test_cases = [
        {"recent_prs": 5, "should_allow": True, "desc": "Well under limit"},
        {"recent_prs": 9, "should_allow": True, "desc": "Just under limit"},
        {"recent_prs": 10, "should_allow": False, "desc": "At limit"},
        {"recent_prs": 15, "should_allow": False, "desc": "Over limit"},
        {"recent_prs": 100, "should_allow": False, "desc": "Way over limit"},
    ]
    
    passed = 0
    failed = 0
    
    for case in test_cases:
        print(f"\n  Testing: {case['desc']}")
        print(f"    Recent PRs: {case['recent_prs']}")
        
        # Rate limit logic from workflow
        should_allow = case['recent_prs'] < 10
        
        if should_allow == case['should_allow']:
            print(f"    ‚úÖ PASS: {'Allowed' if should_allow else 'Blocked'} (expected)")
            passed += 1
        else:
            print(f"    ‚ùå FAIL: {'Allowed' if should_allow else 'Blocked'} (expected {'allow' if case['should_allow'] else 'block'})")
            failed += 1
    
    print(f"\n  Results: {passed} passed, {failed} failed")
    return failed == 0


def test_stale_pr_filtering():
    """Test that stale PR filtering works correctly."""
    print("\n" + "="*80)
    print("Test 3: Stale PR Filtering")
    print("="*80)
    
    from datetime import datetime, timedelta
    
    now = datetime.utcnow()
    
    test_cases = [
        {
            "name": "Fresh auto-generated PR",
            "author": "github-actions[bot]",
            "title": "ü§ñ Copilot: Complete PR #123",
            "updated_at": now - timedelta(hours=2),
            "max_age_hours": 48,
            "should_close": False
        },
        {
            "name": "Stale auto-generated PR",
            "author": "github-actions[bot]",
            "title": "Fix: workflow failure",
            "updated_at": now - timedelta(hours=72),
            "max_age_hours": 48,
            "should_close": True
        },
        {
            "name": "Manual PR (should not close)",
            "author": "human-user",
            "title": "Fix: Bug in code",
            "updated_at": now - timedelta(hours=100),
            "max_age_hours": 48,
            "should_close": False
        },
        {
            "name": "Fresh copilot PR",
            "author": "app/copilot-swe-agent",
            "title": "Automated fix",
            "updated_at": now - timedelta(hours=1),
            "max_age_hours": 48,
            "should_close": False
        },
        {
            "name": "Stale copilot PR",
            "author": "app/copilot-swe-agent",
            "title": "Automated fix",
            "updated_at": now - timedelta(hours=60),
            "max_age_hours": 48,
            "should_close": True
        }
    ]
    
    passed = 0
    failed = 0
    
    for case in test_cases:
        print(f"\n  Testing: {case['name']}")
        print(f"    Author: {case['author']}")
        print(f"    Age: {int((now - case['updated_at']).total_seconds() / 3600)} hours")
        
        # Filtering logic from script
        is_auto_author = case['author'] in ['github-actions[bot]', 'app/copilot-swe-agent']
        is_stale = (now - case['updated_at']).total_seconds() / 3600 > case['max_age_hours']
        should_close = is_auto_author and is_stale
        
        if should_close == case['should_close']:
            print(f"    ‚úÖ PASS: {'Close' if should_close else 'Keep'} (expected)")
            passed += 1
        else:
            print(f"    ‚ùå FAIL: {'Close' if should_close else 'Keep'} (expected {'close' if case['should_close'] else 'keep'})")
            failed += 1
    
    print(f"\n  Results: {passed} passed, {failed} failed")
    return failed == 0


def test_feedback_loop_prevention():
    """Test that the feedback loop is prevented."""
    print("\n" + "="*80)
    print("Test 4: Feedback Loop Prevention")
    print("="*80)
    
    print("\n  Scenario: Workflow fails and auto-healing creates issue")
    print("    1. Workflow 'Docker Build' fails")
    print("    2. copilot-agent-autofix.yml creates issue #100")
    print("       Title: 'Fix: Docker Build workflow failure (Run 12345)'")
    print("       Body: 'Auto-generated by: Workflow Auto-Healing System'")
    print("    3. Issue #100 is opened (triggers issue-to-draft-pr.yml)")
    print("    4. issue-to-draft-pr.yml checks if auto-generated...")
    
    # Simulate the check
    issue_title = "Fix: Docker Build workflow failure (Run 12345)"
    issue_body = "Auto-generated by: Workflow Auto-Healing System\nRun ID: 12345"
    
    is_auto_generated = False
    if "Fix:" in issue_title or "workflow failure" in issue_title:
        if any(keyword in issue_body for keyword in ["Auto-generated", "auto-healing", "automated workflow"]):
            is_auto_generated = True
    
    print(f"       Auto-generated detected: {is_auto_generated}")
    
    if is_auto_generated:
        print("    5. ‚úÖ issue-to-draft-pr.yml SKIPS (no duplicate PR created)")
        print("    6. copilot-agent-autofix.yml creates its own PR")
        print("    7. Result: 1 PR total ‚úÖ")
        print("\n  ‚úÖ PASS: Feedback loop prevented")
        return True
    else:
        print("    5. ‚ùå issue-to-draft-pr.yml creates PR")
        print("    6. copilot-agent-autofix.yml also creates PR")
        print("    7. Result: 2 PRs total ‚ùå")
        print("\n  ‚ùå FAIL: Feedback loop NOT prevented")
        return False


def main():
    """Run all tests."""
    print("\n" + "="*80)
    print("DRAFT PR SPAM PREVENTION - TEST SUITE")
    print("="*80)
    print("\nThis test validates that the fixes prevent 100+ draft PRs from being created.\n")
    
    results = []
    
    results.append(("Auto-Generated Detection", test_auto_generated_detection()))
    results.append(("Rate Limiting", test_rate_limiting()))
    results.append(("Stale PR Filtering", test_stale_pr_filtering()))
    results.append(("Feedback Loop Prevention", test_feedback_loop_prevention()))
    
    # Summary
    print("\n" + "="*80)
    print("TEST SUMMARY")
    print("="*80)
    
    passed = sum(1 for _, result in results if result)
    total = len(results)
    
    for name, result in results:
        status = "‚úÖ PASS" if result else "‚ùå FAIL"
        print(f"{status}: {name}")
    
    print(f"\nTotal: {passed}/{total} test suites passed")
    
    if passed == total:
        print("\n‚úÖ All tests passed! The fix should prevent draft PR spam.")
        return 0
    else:
        print(f"\n‚ùå {total - passed} test suite(s) failed! Review the implementation.")
        return 1


if __name__ == '__main__':
    sys.exit(main())
